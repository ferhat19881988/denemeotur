<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deneme Öğrenci Oturma Planı</title>
<style>
  /* ====== Modern Tema Değişkenleri ====== */
  :root{
    --bg: #0f172a;
    --card: #1e293b;
    --card-hover: #334155;
    --muted: #94a3b8;
    --text: #f1f5f9;
    --accent: #3b82f6;        
    --accent-hover: #2563eb;
    --danger: #ef4444;
    --warn: #eab308;
    --ok: #22c55e;
    --border: #334155;
    --field: #020617;
    --radius: 12px;
    --radius-lg: 16px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --glass: rgba(30, 41, 59, 0.7);
    --glass-border: rgba(255, 255, 255, 0.08);
    --focus-ring: 0 0 0 2px rgba(59, 130, 246, 0.5);
  }
  .theme-light{
    --bg: #f8fafc;
    --card: #ffffff;
    --card-hover: #f1f5f9;
    --muted: #64748b;
    --text: #0f172a;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --danger: #dc2626;
    --warn: #ca8a04;
    --ok: #16a34a;
    --border: #e2e8f0;
    --field: #f1f5f9;
    --glass: rgba(255, 255, 255, 0.8);
    --glass-border: rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }

  /* ====== Genel Yapı ====== */
  *{box-sizing:border-box}
  body{
    margin:0;
    background: var(--bg);
    color:var(--text);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    height: 100vh;
    overflow-y: auto;
    transition: background 0.3s ease, color 0.3s ease;
  }
   
  .hidden{display:none !important}
   
  .wrap{
    max-width:1400px;
    margin: 40px auto;
    padding: 24px;
    border-radius: var(--radius-lg);
    background: var(--card);
    border: 1px solid var(--glass-border);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  /* ====== Başlık & Navigasyon ====== */
  .app-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px; padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  .app-title { font-size: 1.25rem; font-weight: 700; color: var(--text); display:flex; align-items:center; gap:10px; }
  .status-dot { width:10px; height:10px; background:var(--ok); border-radius:50%; box-shadow: 0 0 8px var(--ok); }

  .tabs{
    display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 24px;
    background: var(--field); padding: 6px; border-radius: var(--radius);
    border: 1px solid var(--border);
  }
  .tab-btn{
    flex: 1;
    display:inline-flex; align-items:center; justify-content: center; gap:8px;
    border:none; background:transparent; color:var(--muted);
    padding: 10px 16px; border-radius: calc(var(--radius) - 4px);
    cursor:pointer; font-weight: 500; transition: all 0.2s;
  }
  .tab-btn:hover { color: var(--text); background: var(--glass-border); }
  .tab-btn.active{
    background: var(--card); color: var(--accent);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-weight: 600;
  }
  .tab-btn svg { width: 18px; height: 18px; }

  /* ====== Form Elemanları ====== */
  label{display:block; margin-bottom:6px; font-size:0.85rem; color:var(--muted); font-weight:500}
  input, select, button, textarea {
    width:100%; padding:10px 14px;
    border-radius: var(--radius); border:1px solid var(--border);
    background: var(--field); color:var(--text);
    font-size: 0.9rem; transition: all 0.2s;
  }
  input[type="date"] { cursor: pointer; }
  input:focus, select:focus, textarea:focus { outline:none; border-color:var(--accent); box-shadow: var(--focus-ring); }
   
  button{ width:auto; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:6px; justify-content:center; }
  button:active { transform: translateY(1px); }
   
  button.primary{ background: var(--accent); border-color: var(--accent); color: white; }
  button.primary:hover{ background: var(--accent-hover); }
   
  button.danger{ background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); color: var(--danger); }
  button.danger:hover{ background: rgba(239, 68, 68, 0.2); }
   
  button.firebase-btn { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2); color: var(--ok); }
  button.firebase-btn:hover { background: rgba(16, 185, 129, 0.2); }

  .btn-sm{ padding: 6px 10px; font-size: 0.8rem; border-radius: 8px; }
  .toolbar { display:flex; gap:10px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }

  /* ====== Gözetmen Çoklu Seçim ====== */
  .multi-select-container { position: relative; width: 100%; }
  .multi-select-btn {
    text-align: left; background: var(--field); border: 1px solid var(--border);
    padding: 8px 12px; border-radius: var(--radius); cursor: pointer;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    min-height: 38px; display: flex; align-items: center; justify-content: space-between;
  }
  .multi-select-btn::after { content: '▼'; font-size: 0.7rem; opacity: 0.6; }
  .multi-select-dropdown {
    position: absolute; top: 100%; left: 0; right: 0;
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); z-index: 50;
    max-height: 200px; overflow-y: auto; display: none;
    box-shadow: var(--shadow); margin-top: 4px; padding: 4px;
  }
  .multi-select-dropdown.show { display: block; }
  .multi-select-option {
    padding: 6px 10px; border-radius: 6px; cursor: pointer;
    display: flex; align-items: center; gap: 8px; font-size: 0.85rem;
    transition: background 0.1s;
  }
  .multi-select-option:hover { background: var(--card-hover); }
  .multi-select-option input { width: auto; margin: 0; cursor: pointer; }

  /* ====== Listeler & Grid ====== */
  .row{display:flex; gap:16px; flex-wrap:wrap}
  .col{flex:1; min-width:300px}
  .card{ background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
  .card h2 { margin-top:0; font-size:1.1rem; color: var(--text); margin-bottom: 16px; display:flex; align-items:center; justify-content:space-between; }
   
  .list-container {
    height: 400px; overflow-y:auto; 
    border:1px solid var(--border); border-radius: var(--radius); 
    background: var(--field); padding:8px;
  }
  .student-item {
    padding: 10px; margin-bottom:6px;
    background: var(--card); border:1px solid var(--border);
    /* Sol border dinamik atanacak ama varsayılanı burada */
    border-left-width: 5px;
    border-radius: 8px; display:flex; justify-content:space-between; align-items:center;
    font-size: 0.9rem;
  }
   
  /* ====== Sürükle Bırak & Yeni Atama Dizaynı ====== */
  .assign-layout {
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }
  .pool-panel {
    flex: 0 0 300px;
    background: var(--field);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    position: sticky;
    top: 20px;
  }
  .classes-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }
  .class-drop-zone {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    min-height: 200px;
    transition: all 0.2s;
    display: flex; flex-direction: column;
  }
  .class-drop-zone.drag-over {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.05);
    box-shadow: 0 0 0 2px var(--accent);
  }
  .pool-list {
    min-height: 200px;
  }

  .draggable-chip {
    padding: 8px 12px; margin-bottom: 8px;
    background: var(--card); 
    border: 1px solid var(--border);
    /* Border-left JS ile dinamik renklendirilecek */
    border-left-width: 5px; 
    border-radius: 8px; cursor: grab;
    display:flex; justify-content:space-between; align-items:center;
    user-select: none; transition: transform 0.1s, box-shadow 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .draggable-chip:active { cursor: grabbing; transform: scale(0.98); }
   
  /* ====== Tablo ====== */
  table { width:100%; border-collapse:collapse; font-size:0.9rem; }
  th { text-align:left; color:var(--muted); font-weight:600; padding:10px; border-bottom:1px solid var(--border); }
  td { padding:10px; border-bottom:1px solid var(--border); color:var(--text); vertical-align: top;}
   
  /* ====== KPI Paneli ====== */
  .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:16px; }
  .kpi-card { background:linear-gradient(145deg, var(--card), var(--field)); padding:12px; border-radius:var(--radius); border:1px solid var(--border); text-align:center; }
  .kpi-val { font-size:1.5rem; font-weight:700; color:var(--accent); }
  .kpi-lbl { font-size:0.8rem; color:var(--muted); }

  /* ====== Yazdırma ====== */
  @media print {
    body, .wrap { 
      background:white; color:black !important; 
      border:none; box-shadow:none; margin:0; padding:0; width:100%; overflow:visible; 
    }
    .no-print, .tabs, .app-header, .toolbar, button, .firebase-btn { display:none !important; }
    .print-page { page-break-after: always; margin: 10px; }
    
    /* Liste Yazdırma */
    .print-list-table { width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; color: #000; }
    .print-list-table th, .print-list-table td { 
      border: 1px solid #000; padding: 6px; color: #000; font-size: 12px;
    }
    .print-list-table th { text-align: center; background: #eee; -webkit-print-color-adjust: exact; }
    
    /* YENİ OTURMA PLANI TASARIMI (KUTU DÜZENİ) */
    .seat-grid {
      display:grid;
      grid-template-columns: repeat(var(--cols), 1fr); 
      gap: 10px; 
      justify-content: center;
      margin-top: 10px;
    }
    .seat-box {
      border: 2px solid #000;
      border-radius: 8px;
      padding: 5px;
      height: 110px; /* Yükseklik */
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      background: #fff;
    }
    /* Sıra Numarası (Sol Üst) */
    .seat-idx {
      position: absolute;
      top: 5px; left: 5px;
      width: 20px; height: 20px;
      background: #000; color: #fff;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: bold;
      -webkit-print-color-adjust: exact;
    }
    /* Masa Temsili (Görsel) */
    .seat-desk-visual {
      width: 60%;
      height: 35px;
      border: 2px solid #444;
      background: #eee;
      margin-top: 25px; /* Sıra nosundan uzaklaş */
      margin-bottom: 5px;
      border-radius: 4px;
      -webkit-print-color-adjust: exact;
    }
    /* Öğrenci Bilgileri */
    .seat-info {
      text-align: center;
      width: 100%;
      line-height: 1.2;
    }
    .seat-name {
      font-family: Arial, sans-serif;
      font-weight: bold;
      font-size: 11px;
      color: #000;
      margin-bottom: 2px;
      white-space: normal; /* İsim sığsın diye alt satıra geçsin */
      overflow: hidden;
      max-height: 28px;
    }
    .seat-no {
      font-size: 11px;
      color: #333;
    }
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="app-header no-print">
    <div class="app-title">
      <div class="status-dot"></div>
      <span>Oturma Planı Yöneticisi</span>
    </div>
    <div class="actions inline" style="display:flex; gap:10px">
      <button id="btnTheme" class="btn-sm">Tema Değiştir</button>
    </div>
  </div>

  <div class="tabs no-print">
    <button class="tab-btn active" data-tab="ayarl">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
      Ayarlar
    </button>
    <button class="tab-btn" data-tab="sinif">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
      Sınıflar
    </button>
    <button class="tab-btn" data-tab="takvim">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Takvim
    </button>
    <button class="tab-btn" data-tab="atama">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
      Atama
    </button>
    <button class="tab-btn" data-tab="yazdir">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
      Yazdır
    </button>
  </div>

  <section id="ayarl">
    <div class="card">
      <h2>
        <span>Veri Kaynağı (Google Sheets)</span>
        <div class="inline" style="gap:8px">
          <button id="fbSaveSettings" class="firebase-btn btn-sm">Ayarları Kaydet (Bulut)</button>
          <button id="fbLoadSettings" class="firebase-btn btn-sm">Ayarları Yükle (Bulut)</button>
        </div>
      </h2>
      <div class="row">
        <div class="col">
          <label>Spreadsheet ID</label>
          <input id="sheetId" placeholder="Google Sheet ID" />
        </div>
        <div class="col">
          <label>Öğrenci Sayfa Adı</label>
          <input id="sheetStudentTab" value="Deneme" />
        </div>
        <div class="col">
          <label>Öğretmen Sayfa Adı</label>
          <input id="sheetTeacherTab" value="Ogretmenler" />
        </div>
      </div>
      <div class="toolbar" style="margin-top:16px">
        <button id="btnFetchSheets" class="primary">E-Tablodan Verileri Çek</button>
        <span style="font-size:0.8rem; color:var(--muted)">Tablo "Bağlantıya sahip herkes görüntüleyebilir" olmalıdır.</span>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-val" id="kpiStd">0</div><div class="kpi-lbl">Öğrenci</div></div>
      <div class="kpi-card"><div class="kpi-val" id="kpiTch">0</div><div class="kpi-lbl">Öğretmen</div></div>
      <div class="kpi-card"><div class="kpi-val" id="kpiCls">0</div><div class="kpi-lbl">Sınıf</div></div>
    </div>

    <div class="row">
      <div class="col">
        <div class="card">
          <h2>
            Öğrenci Listesi
            <div class="inline" style="gap:5px">
               <button id="fbSaveStudents" class="firebase-btn btn-sm">Kaydet</button>
               <button id="fbLoadStudents" class="firebase-btn btn-sm">Yükle</button>
            </div>
          </h2>
          <div id="listStudents" class="list-container"></div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h2>
            Öğretmen Listesi
            <div class="inline" style="gap:5px">
               <button id="fbSaveTeachers" class="firebase-btn btn-sm">Kaydet</button>
               <button id="fbLoadTeachers" class="firebase-btn btn-sm">Yükle</button>
            </div>
          </h2>
          <div id="listTeachers" class="list-container"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="sinif" class="hidden">
    <div class="card">
      <h2>
        <span>Sınıf Yönetimi</span>
        <div class="inline" style="gap:8px">
          <button id="fbSaveClasses" class="firebase-btn btn-sm">Sınıfları Kaydet</button>
          <button id="fbLoadClasses" class="firebase-btn btn-sm">Sınıfları Yükle</button>
        </div>
      </h2>
      <div class="toolbar">
        <button id="btnAddClass" class="primary">Yeni Sınıf Ekle</button>
        <button id="btnClearClasses" class="danger">Hepsini Sil</button>
      </div>
      <div style="overflow-x:auto; min-height:400px">
        <table>
          <thead>
            <tr>
              <th>Sınıf Adı</th>
              <th width="80">Kont.</th>
              <th width="80">Düzey</th>
              <th>Gözetmen(ler)</th>
              <th width="80">Satır</th>
              <th width="80">Sütun</th>
              <th width="80">İşlem</th>
            </tr>
          </thead>
          <tbody id="tbodyClasses"></tbody>
        </table>
      </div>
    </div>
  </section>

  <section id="takvim" class="hidden">
    <div class="card">
      <h2>
        <span>Deneme Takvimi</span>
        <div class="inline" style="gap:8px">
          <button id="fbSaveCalendar" class="firebase-btn btn-sm">Takvimi Kaydet</button>
          <button id="fbLoadCalendar" class="firebase-btn btn-sm">Takvimi Yükle</button>
        </div>
      </h2>
      <div class="row" style="align-items:end">
        <div class="col" style="flex:0 0 200px">
          <label>Tarih</label>
          <input type="date" id="calDate" style="cursor:pointer;" onclick="this.showPicker()">
        </div>
        <div class="col" style="flex:0 0 150px">
          <label>Düzey</label>
          <select id="calLevel">
            <option value="8">8. Sınıf</option>
            <option value="7">7. Sınıf</option>
            <option value="6">6. Sınıf</option>
            <option value="5">5. Sınıf</option>
          </select>
        </div>
        <div class="col">
          <button id="btnAddExam" class="primary">Tarih Ekle/Güncelle</button>
        </div>
      </div>
      <div id="calendarList" style="margin-top:20px; display:flex; flex-direction:column; gap:8px;"></div>
    </div>
  </section>

  <section id="atama" class="hidden">
    <div class="card">
      <h2>
        <span>Atama & Yerleşim</span>
        <div class="inline" style="gap:8px">
          <button id="fbSaveAssign" class="firebase-btn btn-sm">Atamaları Kaydet</button>
          <button id="fbLoadAssign" class="firebase-btn btn-sm">Atamaları Yükle</button>
        </div>
      </h2>
      <div class="toolbar" style="background:var(--field); padding:10px; border-radius:8px; border:1px solid var(--border)">
        <div class="inline" style="gap:12px; flex-wrap:wrap">
          <div class="inline">
            <label style="margin:0; margin-right:8px">Düzey:</label>
            <select id="assignLevelFilter" style="width:auto">
              <option value="8">8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option>
            </select>
          </div>
          <div class="inline">
             <label style="margin:0; margin-right:8px">Sırala:</label>
             <select id="assignSort" style="width:auto">
               <option value="rand">Tam Karışık</option>
               <option value="ad">Ada göre</option>
               <option value="soyad">Soyada göre</option>
               <option value="no">Numaraya göre</option>
               <option value="sinif">Sınıfa göre</option>
             </select>
          </div>
          <button id="btnAutoDistribute" class="primary btn-sm">Otomatik Dağıt</button>
          <button id="btnClearAssign" class="danger btn-sm">Temizle</button>
        </div>
      </div>
      
      <div class="assign-layout">
        <div class="pool-panel">
          <h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:8px;">Öğrenci Havuzu</h3>
          <div id="assignPoolList" class="drop-zone pool-list" data-type="pool"></div>
        </div>

        <div id="assignClassGrid" class="classes-grid"></div>
      </div>
    </div>
  </section>

  <section id="yazdir" class="hidden">
    <div class="row no-print">
      <div class="col">
        <div class="card">
          <h2>Liste Yazdır</h2>
          <p class="small text-muted">Sınıf kapılarına asılacak imza listesi (İsimler belirgin).</p>
          <button onclick="app.printList()" class="primary">Listeleri Yazdır</button>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h2>Oturma Planı Yazdır</h2>
          <p class="small text-muted">Sınıf içindeki sıra düzeni (Kutulu Tasarım).</p>
          <button onclick="app.printSeating()" class="primary">Oturma Planı Yazdır</button>
        </div>
      </div>
    </div>
    <div id="printArea" class="hidden"></div>
  </section>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
    authDomain: "odevfeno.firebaseapp.com",
    databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "odevfeno",
    storageBucket: "odevfeno.firebasestorage.app",
    messagingSenderId: "662757516934",
    appId: "1:662757516934:web:0042188832f63deb6fd307",
    measurementId: "G-4Q99NQRB38"
  };

  const fbApp = initializeApp(firebaseConfig);
  const db = getDatabase(fbApp);
  const rootRef = ref(db);

  window.fbSave = async (path, data) => {
    try { await set(ref(db, 'denemeotur/' + path), data); alert('Başarıyla kaydedildi (Firebase).'); } 
    catch(e) { console.error(e); alert('Hata: ' + e.message); }
  };
   
  window.fbLoad = async (path) => {
    try {
      const snap = await get(child(rootRef, 'denemeotur/' + path));
      return snap.exists() ? snap.val() : null;
    } catch(e) { console.error(e); alert('Yükleme hatası: ' + e.message); return null; }
  };
</script>

<script>
/* ================= GLOBAL STATE ================= */
const state = {
  cfg: { 
    sheetId: "1OeDI5rQvWXP6s5OhgRFrh1dThnBMmA9mrCjgYuk1Qtw", 
    tabStudents: "Deneme", 
    tabTeachers: "Ogretmenler", 
    theme: "dark" 
  },
  students: [], teachers: [], classes: [], calendar: []
};

/* ================= YARDIMCILAR ================= */
const $ = id => document.getElementById(id);
const uid = () => Math.random().toString(36).substr(2, 9);
const normalize = s => (s||"").toString().toLowerCase().trim()
  .replace(/ğ/g,"g").replace(/ü/g,"u").replace(/ş/g,"s")
  .replace(/ı/g,"i").replace(/ö/g,"o").replace(/ç/g,"c")
  .replace(/\s/g,"");

// Gelişmiş Karıştırma: Fisher-Yates Shuffle

// Gelişmiş Karıştırma: Fisher-Yates Shuffle
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

/* ================== SINIF RENK SİSTEMİ (OTOMATİK) ==================
   Mantık:
   - Sınıf isimlerini normalize ediyoruz (boşluk/harf farkları kalkıyor).
   - Tüm öğrenciler ve sınıf tanımlarındaki benzersiz sınıf adlarını topluyoruz.
   - Alfabetik sıralayıp, geniş bir renk paletine sırayla dağıtıyoruz.
   - Aynı sınıf adı her yerde aynı rengi alıyor.
   - Yeni sınıf eklenirse, cache yeniden kuruluyor ve renkler yine deterministik.
*/

// "8 A", "8A ", "8-a" → "8A" gibi tek anahtar haline getir
function normalizeClassKey(str) {
  if (!str) return "";
  return str
    .toString()
    .trim()
    .toUpperCase()
    .replace(/\s+/g, "")       // tüm boşlukları kaldır
    .replace(/[^0-9A-ZĞÜŞİÖÇ]/g, ""); // harf/rakam dışını temizle
}

// Birbirinden olabildiğince farklı 12 ana renk
const CLASS_COLOR_PALETTE = [
  "hsl(0, 75%, 58%)",    // canlı kırmızı
  "hsl(11, 80%, 56%)",   // mercan
  "hsl(22, 85%, 55%)",   // koyu turuncu
  "hsl(33, 88%, 55%)",   // turuncu
  "hsl(44, 90%, 55%)",   // sarımsı turuncu
  "hsl(55, 88%, 55%)",   // altın sarısı
  "hsl(66, 70%, 48%)",   // sarı-yeşil
  "hsl(77, 60%, 45%)",   // limon yeşili
  "hsl(88, 55%, 44%)",   // açık yeşil
  "hsl(99, 50%, 42%)",   // çim yeşili
  "hsl(110, 50%, 40%)",  // koyu yeşil
  "hsl(121, 55%, 38%)",  // zümrüt
  "hsl(132, 60%, 40%)",  // mavimsi yeşil
  "hsl(143, 65%, 42%)",  // teal
  "hsl(154, 70%, 45%)",  // camgöbeği
  "hsl(165, 70%, 48%)",  // aqua
  "hsl(176, 75%, 50%)",  // deniz mavisi
  "hsl(187, 75%, 52%)",  // açık mavi
  "hsl(198, 80%, 55%)",  // canlı mavi
  "hsl(209, 80%, 58%)",  // mavi
  "hsl(220, 70%, 58%)",  // çelik mavi
  "hsl(231, 65%, 58%)",  // indigo
  "hsl(242, 65%, 60%)",  // menekşe
  "hsl(253, 65%, 60%)",  // koyu menekşe
  "hsl(264, 65%, 60%)",  // mor
  "hsl(275, 65%, 60%)",  // eflatun
  "hsl(286, 65%, 60%)",  // pembe-mor
  "hsl(297, 70%, 60%)",  // fuşya
  "hsl(308, 70%, 60%)",  // sıcak pembe
  "hsl(319, 70%, 60%)",  // pembe
  "hsl(330, 70%, 60%)",  // gül kurusu
  "hsl(341, 75%, 58%)"   // kırmızıya yakın pembe
];


const classColorCache = {};

// Öğrenciler ve sınıflardaki tüm benzersiz sınıf anahtarlarını toplayıp cache'i kur
function rebuildClassColorCache() {
  const keysSet = new Set();

  // Öğrencilerden sınıf adları
  state.students.forEach(s => {
    const k = normalizeClassKey(s.sinif);
    if (k) keysSet.add(k);
  });

  // Sınıf tanımlarından (örneğin "8A Sınıfı" gibi) isimler
  state.classes.forEach(c => {
    const k = normalizeClassKey(c.name);
    if (k) keysSet.add(k);
  });

  const keys = Array.from(keysSet).sort(); // deterministik olsun

  // Var olan cache bozulmasın; eksik olanlara yeni renk ata
  keys.forEach((k, idx) => {
    if (!classColorCache[k]) {
      const colorIdx = idx % CLASS_COLOR_PALETTE.length;
      classColorCache[k] = CLASS_COLOR_PALETTE[colorIdx];
    }
  });
}

// Dışarıdan kullanılan tek fonksiyon
function getClassColor(str) {
  const key = normalizeClassKey(str);
  if (!key) return "#ccc";

  // Eğer bu anahtar için henüz renk yoksa, cache'i mevcut verilere göre yeniden kur
  if (!classColorCache[key]) {
    rebuildClassColorCache();
  }

  // Hâlâ yoksa (veri çok erken bir aşamadaysa) gri ver
  return classColorCache[key] || "#ccc";
}


/* ================= FIREBASE HANDLERS ================= */
document.addEventListener('DOMContentLoaded', () => {
  $('fbSaveSettings').onclick = () => window.fbSave('ayarlar', state.cfg);
  $('fbLoadSettings').onclick = async () => {
    const val = await window.fbLoad('ayarlar');
    if(val){ state.cfg = {...state.cfg, ...val}; renderSettingsUI(); alert('Ayarlar yüklendi.'); }
  };
  $('fbSaveStudents').onclick = () => window.fbSave('ogrenciler', state.students);
  $('fbLoadStudents').onclick = async () => {
    const val = await window.fbLoad('ogrenciler');
    if(val){ state.students = val || []; renderDataLists(); alert('Öğrenciler yüklendi.'); }
  };
  $('fbSaveTeachers').onclick = () => window.fbSave('ogretmenler', state.teachers);
  $('fbLoadTeachers').onclick = async () => {
    const val = await window.fbLoad('ogretmenler');
    if(val){ state.teachers = val || []; renderDataLists(); renderClassTable(); alert('Öğretmenler yüklendi.'); }
  };
  $('fbSaveClasses').onclick = () => window.fbSave('siniflar', state.classes);
  $('fbLoadClasses').onclick = async () => {
    const val = await window.fbLoad('siniflar');
    if(val){ state.classes = val || []; renderClassTable(); alert('Sınıflar yüklendi.'); }
  };
  $('fbSaveCalendar').onclick = () => window.fbSave('takvim', state.calendar);
  $('fbLoadCalendar').onclick = async () => {
    const val = await window.fbLoad('takvim');
    if(val){ state.calendar = val || []; renderCalendar(); alert('Takvim yüklendi.'); }
  };
  $('fbSaveAssign').onclick = () => window.fbSave('siniflar', state.classes);
  $('fbLoadAssign').onclick = async () => {
    const val = await window.fbLoad('siniflar');
    if(val){ state.classes = val || []; renderAssignUI(); alert('Atamalar yüklendi.'); }
  };
  initApp();
});

/* ================= NAVIGASYON ================= */
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
    const t = btn.dataset.tab;
    $(t).classList.remove('hidden');
    if(t === 'sinif') renderClassTable();
    if(t === 'atama') renderAssignUI();
  });
});

/* ================= GOOGLE SHEETS ================= */
async function fetchSheetData() {
  const sid = $('sheetId').value;
  const sTab = $('sheetStudentTab').value;
  const tTab = $('sheetTeacherTab').value;
  if(!sid) return alert('Spreadsheet ID giriniz.');

  try {
    const urlS = `https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sTab)}`;
    const resS = await fetch(urlS);
    const txtS = await resS.text();
    const jsonS = JSON.parse(txtS.substr(47).slice(0, -2));
    const headersS = jsonS.table.cols.map(c => normalize(c.label));
    let idxNo=0, idxAd=1, idxSin=2;
    if(headersS.includes('no')) idxNo = headersS.indexOf('no');
    if(headersS.includes('adsoyad')) idxAd = headersS.indexOf('adsoyad');
    if(headersS.includes('sinif')) idxSin = headersS.indexOf('sinif');

    state.students = jsonS.table.rows.map(r => ({
      no: String(r.c[idxNo]?.v || "").trim(),
      adsoyad: String(r.c[idxAd]?.v || "").trim(),
      sinif: String(r.c[idxSin]?.v || "").trim()
    })).filter(s => s.no && s.adsoyad);

    const urlT = `https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tTab)}`;
    const resT = await fetch(urlT);
    const txtT = await resT.text();
    const jsonT = JSON.parse(txtT.substr(47).slice(0, -2));
    state.teachers = jsonT.table.rows.map(r => ({
      id: String(r.c[0]?.v||""), ad: String(r.c[1]?.v||""), brans: String(r.c[2]?.v||"")
    })).filter(t => t.id && t.ad);

    state.cfg.sheetId = sid;
    state.cfg.tabStudents = sTab;
    state.cfg.tabTeachers = tTab;
    renderDataLists();
    alert(`Veriler çekildi: ${state.students.length} öğrenci, ${state.teachers.length} öğretmen.`);
  } catch(e) { console.error(e); alert('Hata: Google Sheet okunamadı.'); }
}
$('btnFetchSheets').onclick = fetchSheetData;

function renderSettingsUI(){
  $('sheetId').value = state.cfg.sheetId;
  $('sheetStudentTab').value = state.cfg.tabStudents;
  $('sheetTeacherTab').value = state.cfg.tabTeachers;
  if(state.cfg.theme) applyTheme(state.cfg.theme);
}

// Öğrenci & Öğretmen listeleri (sınıf rengine göre border)
function renderDataLists(){
  $('listStudents').innerHTML = state.students.map(s => {
    const color = getClassColor(s.sinif);
    return `<div class="student-item" style="border-left-color: ${color} !important;">
      <span><b>${s.no}</b> ${s.adsoyad}</span> 
      <span class="badge">${s.sinif}</span>
    </div>`;
  }).join('');
  
  $('listTeachers').innerHTML = state.teachers
    .map(t => `<div class="student-item"><span>${t.ad}</span> <small>${t.brans}</small></div>`)
    .join('');

  $('kpiStd').textContent = state.students.length;
  $('kpiTch').textContent = state.teachers.length;
}

/* ================= SINIF & GÖZETMEN ================= */
$('btnAddClass').onclick = () => {
  state.classes.push({ 
    id: uid(), 
    name: `Sınıf ${state.classes.length+1}`, 
    cap: 20, 
    level: 8, 
    teacherIds: [], 
    rows: 5, 
    cols: 4, 
    students: [] 
  });
  renderClassTable();
};
$('btnClearClasses').onclick = () => { 
  if(confirm('Silinsin mi?')) { 
    state.classes = []; 
    renderClassTable(); 
  } 
};

function createTeacherSelector(classId, selectedIds) {
  const container = document.createElement('div');
  container.className = 'multi-select-container';

  const btn = document.createElement('div');
  btn.className = 'multi-select-btn';
  const selectedNames = state.teachers
    .filter(t => selectedIds.includes(t.id))
    .map(t => t.ad);
  btn.textContent = selectedNames.length > 0 ? selectedNames.join(', ') : 'Gözetmen Seç...';
   
  const dropdown = document.createElement('div');
  dropdown.className = 'multi-select-dropdown';

  state.teachers.forEach(t => {
    const opt = document.createElement('label');
    opt.className = 'multi-select-option';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.value = t.id;
    if(selectedIds.includes(t.id)) chk.checked = true;
    
    chk.onchange = () => {
      const cls = state.classes.find(c => c.id === classId);
      if(chk.checked) cls.teacherIds.push(t.id);
      else cls.teacherIds = cls.teacherIds.filter(id => id !== t.id);
      const newNames = state.teachers
        .filter(teacher => cls.teacherIds.includes(teacher.id))
        .map(teacher => teacher.ad);
      btn.textContent = newNames.length > 0 ? newNames.join(', ') : 'Gözetmen Seç...';
    };

    opt.appendChild(chk);
    opt.appendChild(document.createTextNode(t.ad));
    dropdown.appendChild(opt);
  });

  btn.onclick = (e) => {
    e.stopPropagation();
    document.querySelectorAll('.multi-select-dropdown').forEach(d => {
      if(d !== dropdown) d.classList.remove('show');
    });
    dropdown.classList.toggle('show');
  };

  container.appendChild(btn);
  container.appendChild(dropdown);
  return container;
}

document.addEventListener('click', () => {
  document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
});

function renderClassTable(){
  const tbody = $('tbodyClasses'); 
  tbody.innerHTML = '';
  state.classes.forEach(cls => {
    cls.rows = Math.ceil((parseInt(cls.cap)||1) / (parseInt(cls.cols)||1));
    const tr = document.createElement('tr');
    
    tr.innerHTML = `
      <td><input value="${cls.name}" onchange="updateClass('${cls.id}', 'name', this.value)"></td>
      <td><input type="number" value="${cls.cap}" style="width:60px" onchange="updateClass('${cls.id}', 'cap', this.value)"></td>
      <td>
        <select onchange="updateClass('${cls.id}', 'level', this.value)">
          <option value="8" ${cls.level==8?'selected':''}>8</option>
          <option value="7" ${cls.level==7?'selected':''}>7</option>
          <option value="6" ${cls.level==6?'selected':''}>6</option>
          <option value="5" ${cls.level==5?'selected':''}>5</option>
        </select>
      </td>
      <td class="td-teacher"></td> 
      <td><input value="${cls.rows}" disabled style="width:60px; background:transparent; border:none"></td>
      <td><input type="number" value="${cls.cols}" style="width:60px" onchange="updateClass('${cls.id}', 'cols', this.value)"></td>
      <td><button class="danger btn-sm" onclick="deleteClass('${cls.id}')">Sil</button></td>
    `;
    
    tr.querySelector('.td-teacher')
      .appendChild(createTeacherSelector(cls.id, cls.teacherIds || []));
    tbody.appendChild(tr);
  });
  $('kpiCls').textContent = state.classes.length;
}

window.updateClass = (id, field, val) => {
  const c = state.classes.find(x=>x.id===id);
  if(c) { 
    c[field] = (field==='cap'||field==='cols'||field==='level') ? parseInt(val) : val; 
    renderClassTable(); 
  }
};
window.deleteClass = (id) => {
  if(confirm('Sınıfı silmek istediğine emin misin?')) { 
    state.classes = state.classes.filter(x => x.id !== id); 
    renderClassTable(); 
  }
};

/* ================= TAKVİM ================= */
$('btnAddExam').onclick = () => {
  const d = $('calDate').value; 
  if(!d) return alert('Tarih seçin');
  const lvl = parseInt($('calLevel').value);
  const exist = state.calendar.findIndex(c => c.level === lvl);
  if(exist > -1) state.calendar[exist].date = d;
  else state.calendar.push({ level: lvl, date: d });
  state.calendar.sort((a,b)=>a.level-b.level);
  renderCalendar();
};
function renderCalendar(){
  const list = $('calendarList'); 
  list.innerHTML = '';
  state.calendar.forEach(c => {
    const d = new Date(c.date)
      .toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
    list.innerHTML += `
      <div class="draggable-chip" style="cursor:default">
        <b>${c.level}. Sınıf Deneme</b>: ${d}
        <button class="danger btn-sm" onclick="delCalendar(${c.level})">Sil</button>
      </div>`;
  });
}
window.delCalendar = (lvl) => { 
  state.calendar = state.calendar.filter(c => c.level !== lvl); 
  renderCalendar(); 
};

/* ================= ATAMA & DRAG DROP ================= */
$('assignLevelFilter').onchange = renderAssignUI;
$('assignSort').onchange = renderAssignUI;

/* Seçilen moda göre sıralama (karıştırma yok) */
function sortStudentsByMode(arr, mode) {
  const copy = [...arr];
  if (mode === 'ad') {
    copy.sort((a,b) => (a.adsoyad || '').localeCompare(b.adsoyad || '', 'tr'));
  } else if (mode === 'no') {
    copy.sort((a,b) => (parseInt(a.no) || 0) - (parseInt(b.no) || 0));
  } else if (mode === 'sinif') {
    copy.sort((a,b) => (a.sinif || '').localeCompare(b.sinif || '', 'tr'));
  } else if (mode === 'soyad') {
    const getSurname = (fullName = '') => fullName.trim().split(' ').pop();
    copy.sort((a,b) => getSurname(a.adsoyad).localeCompare(getSurname(b.adsoyad), 'tr'));
  }
  return copy;
}

/* Havuzda görüntülemek için öğrenci listesi */
function getStudentsForAssign(){
  const lvl = $('assignLevelFilter').value;
  let arr = state.students
    .filter(s => s.sinif && s.sinif.toString().startsWith(lvl));
  const sort = $('assignSort').value;

  // Havuzdaki liste sadece görsel sıralama için:
  // - 'Tam Karışık' seçiliyse tamamen karışık
  // - Diğerlerinde seçilen kritere göre A-Z / küçükten büyüğe sıralı
  if (sort === 'rand') {
    arr = shuffleArray(arr);
  } else {
    arr = sortStudentsByMode(arr, sort);
  }

  return arr;
}

function renderAssignUI(){
  const poolList = $('assignPoolList'); poolList.innerHTML = '';
  const classGrid = $('assignClassGrid'); classGrid.innerHTML = '';
   
  const lvl = $('assignLevelFilter').value;
  const students = getStudentsForAssign();
   
  // 1. Havuzu Doldur
  const assignedSet = new Set();
  state.classes.forEach(c => { if(c.students) c.students.forEach(s => assignedSet.add(s)); });
   
  students.forEach(s => {
    if(!assignedSet.has(s.no)) poolList.appendChild(createChip(s));
  });
   
  // 2. Sınıf Gridini Doldur
  state.classes
    .filter(c => c.level == lvl)
    .forEach(c => {
      const zone = document.createElement('div');
      zone.className = 'class-drop-zone drop-zone'; 
      zone.dataset.type = 'class'; 
      zone.dataset.id = c.id;
      
      const current = (c.students || []).length;
      zone.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:12px; border-bottom:1px solid var(--border); padding-bottom:8px;">
          <span style="font-weight:bold; color:var(--accent)">${c.name}</span> 
          <span style="font-size:0.85rem; ${current>c.cap ? 'color:var(--danger)':'color:var(--muted)'}">
            ${current} / ${c.cap}
          </span>
        </div>
        <div style="flex:1; overflow-y:auto; min-height:50px;"></div>
      `;
      
      const container = zone.querySelector('div:last-child');
      (c.students || []).forEach(sNo => {
        const st = state.students.find(x => x.no === sNo) || {no:sNo, adsoyad:'?', sinif:'?'};
        container.appendChild(createChip(st, c.id));
      });
      
      classGrid.appendChild(zone);
    });
   
  initDragAndDrop();
}

// Sınıf rengine göre chip oluşturma
function createChip(student, currentClassId = null) {
  const el = document.createElement('div');
  el.className = 'draggable-chip'; 
  el.draggable = true; 
  el.dataset.no = student.no;
   
  const clr = getClassColor(student.sinif);
  el.style.borderLeftColor = clr;

  el.innerHTML = `
    <div>
      <div style="font-weight:600">${student.adsoyad}</div>
      <div style="font-size:0.75rem; opacity:0.8">${student.no} - ${student.sinif}</div>
    </div>`;
  if(currentClassId) {
    const btn = document.createElement('button'); 
    btn.className = 'danger btn-sm'; 
    btn.innerHTML = '&times;';
    btn.onclick = (e) => { e.stopPropagation(); removeFromClass(student.no, currentClassId); };
    el.appendChild(btn);
  }
  return el;
}

function initDragAndDrop() {
  const chips = document.querySelectorAll('.draggable-chip');
  const zones = document.querySelectorAll('.drop-zone');
   
  chips.forEach(chip => {
    chip.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', chip.dataset.no);
      e.dataTransfer.effectAllowed = 'move';
      chip.style.opacity = '0.5';
    });
    chip.addEventListener('dragend', () => { 
      chip.style.opacity = '1'; 
      zones.forEach(z => z.classList.remove('drag-over')); 
    });
    
    // Swap için chip üzerine drop
    chip.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
    chip.addEventListener('drop', e => {
      e.preventDefault(); e.stopPropagation();
      const draggedNo = e.dataTransfer.getData('text/plain');
      const targetNo = chip.dataset.no;
      if(draggedNo === targetNo) return;
      handleSwap(draggedNo, targetNo);
    });
  });
   
  zones.forEach(zone => {
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e => {
      e.preventDefault(); zone.classList.remove('drag-over');
      const studentNo = e.dataTransfer.getData('text/plain');
      if(!studentNo) return;
      
      const targetClassId = zone.dataset.id;
      const targetType = zone.dataset.type;
      
      let sourceClassId = null;
      state.classes.forEach(c => { if((c.students||[]).includes(studentNo)) sourceClassId = c.id; });
      
      if(sourceClassId === targetClassId && targetType === 'class') return;
      
      if(targetType === 'pool') { 
        if(sourceClassId) removeFromClass(studentNo, sourceClassId); 
      }
      else if(targetType === 'class') {
        const targetClass = state.classes.find(c => c.id === targetClassId);
        if(!targetClass.students) targetClass.students = [];
        if(targetClass.students.length >= targetClass.cap) return alert('Kapasite dolu!');
        
        if(sourceClassId) { 
          const src = state.classes.find(c => c.id === sourceClassId);
          src.students = src.students.filter(x => x !== studentNo);
        }
        if(!targetClass.students.includes(studentNo)) targetClass.students.push(studentNo);
        renderAssignUI();
      }
    });
  });
}

function handleSwap(no1, no2) {
  let c1 = null, c2 = null;
  state.classes.forEach(c => { if((c.students||[]).includes(no1)) c1 = c; });
  state.classes.forEach(c => { if((c.students||[]).includes(no2)) c2 = c; });
   
  if(!c1 || !c2) return; 
  const idx1 = c1.students.indexOf(no1);
  const idx2 = c2.students.indexOf(no2);
  c1.students[idx1] = no2;
  c2.students[idx2] = no1;
  renderAssignUI();
}

function removeFromClass(no, classId){
  const c = state.classes.find(x=>x.id===classId);
  if(c) { c.students = c.students.filter(x => x !== no); renderAssignUI(); }
}

/* OTOMATİK DAĞIT
   - Her zaman TEK havuz (seviye filtresine göre).
   - Sıralama: seçilen moda göre global liste.
   - Dağıtım: önce 1. sınıf kapasitesi dolana kadar, sonra 2, sonra 3...
   - Sadece 'Tam Karışık' modunda bu global liste karıştırılıyor.
*/
$('btnAutoDistribute').onclick = () => {
  const lvl = $('assignLevelFilter').value;
  const sortMode = $('assignSort').value;
  const targets = state.classes.filter(c => c.level == lvl);

  if (!targets.length) {
    alert('Bu düzey için tanımlı sınıf yok.');
    return;
  }

  // Mevcut atamaları temizle
  targets.forEach(c => { c.students = []; });

  // Bu düzeydeki TÜM öğrenciler (sınıf etiketi ne olursa olsun)
  const allLevelStudents = state.students
    .filter(s => s.sinif && s.sinif.toString().startsWith(lvl));

  if (!allLevelStudents.length) {
    renderAssignUI();
    return;
  }

  // Global liste: mod = rand ise karışık, değilse seçilen ölçüte göre sıralı
  let ordered;
  if (sortMode === 'rand') {
    ordered = shuffleArray([...allLevelStudents]);
  } else {
    ordered = sortStudentsByMode(allLevelStudents, sortMode);
  }

  // Sırasıyla: önce 1. sınıf dolana kadar, sonra 2, sonra 3...
  let classIndex = 0;
  for (const stu of ordered) {
    // dolu sınıfları atla
    while (classIndex < targets.length &&
           (targets[classIndex].students || []).length >= targets[classIndex].cap) {
      classIndex++;
    }
    if (classIndex >= targets.length) break; // tüm sınıflar dolu

    if (!targets[classIndex].students) targets[classIndex].students = [];
    targets[classIndex].students.push(stu.no);
  }

  renderAssignUI();
};

$('btnClearAssign').onclick = () => {
  if(confirm('Temizlensin mi?')){
    const lvl = $('assignLevelFilter').value; 
    state.classes
      .filter(c => c.level == lvl)
      .forEach(c => c.students = []);
    renderAssignUI();
  }
};

/* ================= YAZDIRMA ================= */
const app = {
  printList: () => {
    const area = $('printArea'); 
    area.innerHTML = ''; 
    area.classList.remove('hidden');
    state.classes.forEach(c => {
      const page = document.createElement('div'); 
      page.className = 'print-page';
      const tch = c.teacherIds
        .map(id => state.teachers.find(t=>t.id===id)?.ad || "")
        .join(', ');
      const cal = state.calendar.find(x=>x.level===c.level)?.date || "";
      const dFormatted = cal ? new Date(cal).toLocaleDateString('tr-TR') : "-";
      
      let html = `
        <h2 style="text-align:center; margin-bottom:10px; color:#000;">
          ${c.name} - Sınav İmza Listesi
        </h2>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold; font-family:Arial; color:#000;">
           <span>Tarih: ${dFormatted}</span> 
           <span>Gözetmen: ${tch}</span>
        </div>
        <table class="print-list-table">
          <thead>
            <tr>
              <th width="40" style="text-align:center">#</th>
              <th width="60" style="text-align:center">No</th>
              <th style="font-weight:bold; text-align:left">Ad Soyad</th>
              <th width="80" style="text-align:center">Sınıf</th>
              <th width="100">İmza</th>
            </tr>
          </thead>
          <tbody>
      `;
      (c.students||[]).forEach((sNo, i) => {
        const s = state.students.find(x=>x.no===sNo) || {no:sNo, adsoyad:'?', sinif:''};
        html += `
          <tr>
            <td style="text-align:center">${i+1}</td>
            <td style="text-align:center; font-weight:bold">${s.no}</td>
            <td style="font-weight:bold">${s.adsoyad}</td>
            <td style="text-align:center">${s.sinif}</td>
            <td></td>
          </tr>`;
      });
      html += `</tbody></table>`;
      page.innerHTML = html;
      area.appendChild(page);
    });
    window.print(); 
    area.classList.add('hidden');
  },
   
  printSeating: () => {
    const area = $('printArea'); 
    area.innerHTML = ''; 
    area.classList.remove('hidden');
    state.classes.forEach(c => {
      const page = document.createElement('div'); 
      page.className = 'print-page';
      const tch = c.teacherIds
        .map(id => state.teachers.find(t=>t.id===id)?.ad || "")
        .join(', ');
      const cal = state.calendar.find(x=>x.level===c.level)?.date || "";
      const dFormatted = cal ? new Date(cal).toLocaleDateString('tr-TR') : "-";

      let gridHtml = `<div class="seat-grid" style="--cols: ${c.cols}">`;
      for(let i=0; i<c.cap; i++){
        const sNo = (c.students||[])[i];
        const student = sNo 
          ? (state.students.find(x=>x.no===sNo) || {no:sNo, adsoyad:sNo}) 
          : null;
        
        let contentHtml = '';
        if(student) {
          contentHtml = `
            <div class="seat-idx">${i+1}</div>
            <div class="seat-desk-visual"></div>
            <div class="seat-info">
              <div class="seat-name">${student.adsoyad}</div>
              <div class="seat-no">${student.no}</div>
            </div>
          `;
        } else {
          contentHtml = `
            <div class="seat-idx">${i+1}</div>
            <div class="seat-desk-visual" style="opacity:0.3"></div>
            <div class="seat-info">
              <div class="seat-name" style="color:#aaa; font-weight:normal;">BOŞ</div>
            </div>
          `;
        }

        gridHtml += `<div class="seat-box">${contentHtml}</div>`;
      }
      gridHtml += `</div>`;
      
      page.innerHTML = `
        <h2 style="text-align:center; font-family:Arial; color:#000;">
          ${c.name} Oturma Planı
        </h2>
        <div style="text-align:center; margin-bottom:20px; font-family:Arial; font-weight:bold; color:#000;">
          ${dFormatted} - ${tch}
        </div>
        ${gridHtml}`;
      area.appendChild(page);
    });
    window.print(); 
    area.classList.add('hidden');
  }
};

/* ================= INIT & THEME ================= */
$('btnTheme').onclick = () => {
  state.cfg.theme = state.cfg.theme === 'light' ? 'dark' : 'light';
  applyTheme(state.cfg.theme);
};
function applyTheme(thm){
  if(thm === 'light') document.body.classList.add('theme-light');
  else document.body.classList.remove('theme-light');
}
function initApp(){ 
  applyTheme('dark'); 
  renderSettingsUI(); 
}
</script>


</body>
</html>




