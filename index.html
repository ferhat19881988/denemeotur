<!-- /mnt/data/index.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Deneme Öğrenci Oturma Planı</title>
<style>
  /* ====== macOS benzeri tema değişkenleri ====== */
  :root{
    --bg:#0b0e14;
    --card:#111522;
    --muted:#8fa1b3;
    --text:#eef4ff;
    --accent:#0A84FF;          /* macOS mavi */
    --accent-2:#30d158;        /* macOS yeşil */
    --danger:#ff453a;          /* macOS kırmızı */
    --warn:#ffd60a;
    --ok:#32d74b;
    --border:#1f2a3f;
    --field:#0f1422;
    --table-h:#a9b8cc;

    --radius:14px;
    --radius-lg:18px;
    --shadow:0 10px 30px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.02) inset;
    --glass:rgba(255,255,255,.06);
    --glassBorder:rgba(255,255,255,.10);
    --focus:0 0 0 3px color-mix(in oklab, var(--accent) 50%, transparent);
  }
  .theme-light{
    --bg:#f5f6fa;
    --card:#ffffff;
    --muted:#5d6b7a;
    --text:#0a1728;
    --accent:#0A84FF;
    --accent-2:#34c759;
    --danger:#ff3b30;
    --warn:#b88900;
    --ok:#2f9e44;
    --border:#e4e8f2;
    --field:#f7f9fe;
    --table-h:#263448;

    --glass:rgba(255,255,255,.7);
    --glassBorder:rgba(0,0,0,.08);
    --shadow:0 10px 24px rgba(22,27,45,.08);
  }

  /* ====== Genel ====== */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(180deg, color-mix(in oklab, var(--bg), #000 6%), var(--bg));
    color:var(--text);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .visually-hidden{position:absolute!important;width:1px;height:1px;margin:-1px;border:0;padding:0;clip:rect(0 0 0 0);overflow:hidden}
  /* FIX: Sekme dışı bölümleri gizlemek için */
  .hidden{display:none !important}

  /* Pencere görünümü */
  .wrap{
    max-width:1200px;
    margin:32px auto;
    padding:0 16px 20px;
    border-radius:calc(var(--radius-lg) + 4px);
    box-shadow:var(--shadow);
    backdrop-filter:saturate(140%) blur(20px);
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--card), #fff 2%), var(--card));
    border:1px solid var(--glassBorder);
  }

  /* ====== mac Başlık Çubuğu ====== */
  .mac-titlebar{
    position:sticky; top:0;
    z-index:5;
    display:flex; align-items:center; gap:12px;
    height:46px; padding:0 14px;
    border-bottom:1px solid var(--glassBorder);
    background:color-mix(in oklab, var(--glass) 70%, transparent);
    -webkit-backdrop-filter:saturate(140%) blur(18px);
    backdrop-filter:saturate(140%) blur(18px);
    border-top-left-radius:calc(var(--radius-lg) + 4px);
    border-top-right-radius:calc(var(--radius-lg) + 4px);
  }
  .traffic{display:flex; gap:8px; align-items:center}
  .traffic .dot{width:12px;height:12px;border-radius:50%;border:1px solid rgba(0,0,0,.15);box-shadow:0 1px 0 rgba(255,255,255,.35) inset}
  .traffic .red{background:#ff5f57}
  .traffic .yellow{background:#febc2e}
  .traffic .green{background:#28c840}
  .mac-title{font-weight:600; letter-spacing:.2px; opacity:.9}
  .title-spacer{margin-left:auto}

  /* ====== Sekmeler (Segmented Control + ikon) ====== */
  .tabs{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    margin:12px 0 14px; padding:10px;
    background:color-mix(in oklab, var(--glass) 70%, transparent);
    border:1px solid var(--glassBorder);
    border-radius:999px;
    -webkit-backdrop-filter:saturate(140%) blur(18px);
    backdrop-filter:saturate(140%) blur(18px);
  }
  .tab-btn{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid transparent;
    background:transparent;
    color:var(--text);
    padding:8px 12px;
    border-radius:999px;
    cursor:pointer;
    transition:transform .06s ease, background .2s ease, border-color .2s ease;
    user-select:none;
    white-space:nowrap;
  }
  .tab-btn .icon{width:16px;height:16px;display:block;opacity:.9}
  .tab-btn:hover{background:color-mix(in oklab, var(--accent) 6%, transparent)}
  .tab-btn:active{transform:translateY(1px)}
  .tab-btn.active{
    background:color-mix(in oklab, var(--accent) 14%, var(--card));
    border-color:color-mix(in oklab, var(--accent) 35%, var(--glassBorder));
    box-shadow:0 0 0 1px color-mix(in oklab, var(--accent) 55%, transparent) inset;
  }
  .right{margin-left:auto; display:flex; align-items:center; gap:8px}

  /* ====== Kartlar ====== */
  .card{
    background:linear-gradient(180deg, color-mix(in oklab, var(--card), #fff 1%), var(--card));
    border:1px solid var(--glassBorder);
    border-radius:var(--radius-lg);
    padding:16px;
    margin:10px 0;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
  }

  /* ====== Tipografi ====== */
  h1,h2,h3{margin:.2rem 0 .6rem}
  h1{font-size:1.3rem}
  h2{font-size:1.1rem;color:var(--text); opacity:.9}
  h3{font-size:1rem; opacity:.9}
  a{color:var(--accent); text-decoration:none}
  a:hover{text-decoration:underline}

  /* ====== Formlar / Butonlar (mac benzeri) ====== */
  label{display:block;margin:6px 0 4px;color:var(--muted)}
  input,select,button,textarea{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:linear-gradient(180deg, var(--field), color-mix(in oklab, var(--field), #fff 3%));
    color:var(--text);
    box-shadow:0 1px 0 rgba(255,255,255,.04) inset;
    transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  input::placeholder, textarea::placeholder{color:color-mix(in oklab, var(--muted), #fff 20%); opacity:.7}
  button{cursor:pointer; width:auto}
  button.primary{
    background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 18%, var(--field)), var(--field));
    border-color:color-mix(in oklab, var(--accent) 55%, var(--border));
  }
  button.danger{
    background:linear-gradient(180deg, color-mix(in oklab, var(--danger) 22%, var(--field)), var(--field));
    border-color:color-mix(in oklab, var(--danger) 55%, var(--border));
  }
  .btn-sm{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--field);color:var(--text);cursor:pointer}
  .btn-sm:hover, button:hover{border-color:color-mix(in oklab, var(--accent) 40%, var(--border))}
  .btn-sm:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, button:focus-visible{outline:none; box-shadow:var(--focus)}

  /* Tema düğmesi — segment switch görünümü */
  #btnTheme{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    background:linear-gradient(180deg, var(--card), color-mix(in oklab, var(--card), #fff 2%));
  }

  /* ====== Düzen yardımcıları ====== */
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 280px;min-width:260px}
  .small{font-size:.85rem;color:var(--muted)}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:var(--field);border:1px solid var(--border)}
  .grid{display:grid;gap:8px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .inline{display:inline-flex;gap:8px;align-items:center}
  .gap-8{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* ====== Liste & Öğrenci Chip ====== */
  .list{display:flex;flex-direction:column;gap:6px;max-height:480px;overflow:auto;padding:6px;border:1px solid var(--border);border-radius:12px;background:var(--card)}
  .student{
    padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--field);
    cursor:grab;display:flex;gap:8px;align-items:center;justify-content:space-between;
    transition:transform .06s ease, border-color .2s ease;
  }
  .student:active{transform:scale(.995)}
  .student .meta{flex:1 1 auto;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .assigned { text-decoration: line-through; opacity: .6; cursor: not-allowed; }

  .chip-actions{display:flex;gap:6px;align-items:center}
  .chip-badge{font-size:.75rem;border:1px dashed var(--border);padding:2px 6px;border-radius:8px}

  .class-col{min-width:260px}
  .drop{min-height:80px;border:2px dashed var(--border);border-radius:12px;padding:8px;transition:border-color .2s ease}
  .drop:focus-within{border-color:color-mix(in oklab, var(--accent) 45%, var(--border))}

  /* ====== Tablo ====== */
  table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
  th,td{border-bottom:1px dashed var(--border);padding:8px 6px;text-align:left}
  th{color:var(--table-h); font-weight:600}

  /* ====== Modal ====== */
  .modal-backdrop{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center;z-index:1000}
  .modal{background:var(--card);border:1px solid var(--glassBorder);border-radius:14px;padding:16px;max-width:420px;width:92%;box-shadow:var(--shadow)}
  .modal h3{margin-top:0}
  .modal .btns{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  /* ====== Mac keycap ====== */
  .keycap{
    display:inline-flex;align-items:center;justify-content:center;
    min-width:20px;padding:2px 6px;border-radius:6px;
    border:1px solid var(--glassBorder); background:linear-gradient(180deg, #fff2, #0001);
    box-shadow:0 1px 0 rgba(255,255,255,.3) inset, 0 1px 1px rgba(0,0,0,.1);
    font:600 12px/1.2 ui-monospace, "SF Mono", Menlo, Consolas, monospace;
    color:var(--text);
  }

  /* ====== Yazdır ====== */
  @media print{
    body *{visibility:hidden}
    #printRoot, #printRoot *{visibility:visible}
    #printRoot{position:absolute;left:0;top:0;width:100%}
    .print-page{page-break-after:always}
    .print-title{font:600 18px/1.3 Arial;margin-bottom:6px;color:#000}
    .print-sub{font:600 14px/1.3 Arial;margin-bottom:12px;color:#000}
    table{font:12px Arial;color:#000}
    th,td{border:1px solid #000}
    .print-list td:nth-child(2), .print-list th:nth-child(2){text-align:center;font-weight:700}
    .print-list td:nth-child(2){font-size:16px}
    .seat-grid{
      --cols: 4;
      display:grid;
      grid-template-columns: repeat(var(--cols), minmax(90px, 1fr));
      gap:10px;
      align-items:start;
    }
    .seat{
      display:flex;flex-direction:column;align-items:center;gap:6px;
      border:1px solid #000;padding:6px;border-radius:10px;
    }
    .seat svg{width:70px;height:44px;display:block}
    .seat .idx{font:700 11px Arial;color:#000}
    .seat .nm{
      font:12px/1.2 Arial;color:#000;
      max-width:120px; white-space:normal; word-break:break-word; text-align:center;
    }
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- macOS başlık çubuğu -->
  <div class="mac-titlebar no-print">
    <div class="traffic">
      <span class="dot red"></span>
      <span class="dot yellow"></span>
      <span class="dot green"></span>
    </div>
    <div class="mac-title">Deneme Öğrenci Oturma Planı</div>
    <div class="title-spacer"></div>
  </div>

  <h1 class="visually-hidden">Deneme Öğrenci Oturma Planı</h1>

  <!-- İkonlu yatay sekmeler -->
  <div class="tabs no-print">
    <button class="tab-btn active" data-tab="ayarl" title="Ayarlar">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm9 3c0-.5-.06-.98-.18-1.44l2.05-1.6-2-3.46-2.49 1a8.92 8.92 0 0 0-2.5-1.45l-.38-2.64H8.5l-.38 2.64c-.9.3-1.73.73-2.5 1.45l-2.49-1-2 3.46 2.05 1.6A8.9 8.9 0 0 0 3 12c0 .5.06.98.18 1.44l-2.05 1.6 2 3.46 2.49-1c.77.72 1.6 1.15 2.5 1.45l.38 2.64h7l.38-2.64c.9-.3 1.73-.73 2.5-1.45l2.49 1 2-3.46-2.05-1.6c.12-.46.18-.94.18-1.44Z" fill="currentColor"/>
      </svg>
      <span>Ayarlar</span>
    </button>
    <button class="tab-btn" data-tab="sinif" title="Sınıflar">
      <svg class="icon" viewBox="0 0 24 24"><path d="M3 4h8v8H3V4Zm10 0h8v8h-8V4ZM3 12h8v8H3v-8Zm10 4h8v4h-8v-4Z" fill="currentColor"/></svg>
      <span>Sınıflar</span>
    </button>
    <button class="tab-btn" data-tab="takvim" title="Deneme Takvimi">
      <svg class="icon" viewBox="0 0 24 24"><path d="M7 2v2H5a2 2 0 0 0-2 2v2h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7Zm14 8H3v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V10ZM7 14h4v4H7v-4Z" fill="currentColor"/></svg>
      <span>Takvim</span>
    </button>
    <button class="tab-btn" data-tab="atama" title="Atama & Düzen">
      <svg class="icon" viewBox="0 0 24 24"><path d="M7 7h10v2H7V7Zm0 4h10v2H7v-2Zm0 4h6v2H7v-2Z" fill="currentColor"/><path d="M4 12 2 10l4-4 2 2-4 4Zm16 0 2 2-4 4-2-2 4-4Z" fill="currentColor"/></svg>
      <span>Atama</span>
    </button>
    <button class="tab-btn" data-tab="yazdir" title="Yazdır">
      <svg class="icon" viewBox="0 0 24 24"><path d="M7 3h10v4H7V3Zm10 14H7v4h10v-4Zm1-8H6a3 3 0 0 0-3 3v5h4v-3h10v3h4v-5a3 3 0 0 0-3-3Z" fill="currentColor"/></svg>
      <span>Yazdır</span>
    </button>
    <span class="right">
      <button id="btnTheme" title="Temayı değiştir">Tema: Açık</button>
    </span>
  </div>

  <!-- 1) AYARLAR -->
  <section id="ayarl" class="card">
    <h2>Ayarlar & Google E-Tablo</h2>
    <div class="row">
      <div class="col">
        <label>Spreadsheet ID</label>
        <input id="sheetId" placeholder="ör: 1OeDI5rQvWXP6s5OhgRFrh1dThnBMmA9mrCjgYuk1Qtw" />
      </div>
      <div class="col">
        <label>Öğrenci Sayfa Adı</label>
        <input id="sheetStudentTab" value="Deneme" />
      </div>
      <div class="col">
        <label>Öğretmen Sayfa Adı</label>
        <input id="sheetTeacherTab" value="Ogretmenler" />
      </div>
    </div>
    <div class="toolbar inline" style="margin:.5rem 0; flex-wrap:wrap">
      <button id="btnLoad" class="primary">Verileri Yükle</button>
      <button id="btnSaveCfg">Ayarları Kaydet</button>
      <button id="btnLoadCfg">Ayarları Yükle</button>
      <div class="small">Not: E-tablo en az “Bağlantıya sahip olan görüntüleyebilir” olmalı. <span class="keycap">⌘</span><span class="keycap">C</span> / <span class="keycap">⌘</span><span class="keycap">V</span> ile ID yapıştır.</div>
    </div>
    <div class="toolbar inline" style="flex-wrap:wrap">
      <span class="pill">Ayarlar
        <button class="btn-sm" id="expCfg">Kaydet</button>
        <label class="btn-sm">Yükle <input id="impCfg" type="file" accept="application/json" style="width:auto;display:none"></label>
      </span>
      <span class="pill">Öğrenciler
        <button class="btn-sm" id="expStd">Kaydet</button>
        <label class="btn-sm">Yükle <input id="impStd" type="file" accept="application/json" style="width:auto;display:none"></label>
      </span>
      <span class="pill">Öğretmenler
        <button class="btn-sm" id="expTch">Kaydet</button>
        <label class="btn-sm">Yükle <input id="impTch" type="file" accept="application/json" style="width:auto;display:none"></label>
      </span>
    </div>
    <div class="kpi row" style="gap:12px;flex-wrap:wrap">
      <div class="card"><div>Öğrenci</div><div id="kpiStd" class="pill">0</div></div>
      <div class="card"><div>Öğretmen</div><div id="kpiTch" class="pill">0</div></div>
      <div class="card"><div>Son Yükleme</div><div id="kpiLoad" class="pill">-</div></div>
    </div>
    <div class="row">
      <div class="col">
        <h3>Öğrenciler</h3>
        <div id="sampleStd" class="list"></div>
      </div>
      <div class="col">
        <h3>Öğretmenler</h3>
        <div id="sampleTch" class="list"></div>
      </div>
    </div>
  </section>

  <!-- 2) SINIFLAR -->
  <section id="sinif" class="card hidden">
    <h2>Sınıfları Oluştur</h2>
    <div class="toolbar inline" style="flex-wrap:wrap">
      <button id="btnAddClass" class="primary">Yeni Sınıf Ekle</button>
      <button id="btnClearClass" class="danger">Tüm Sınıfları Sil</button>
      <span class="pill">Sınıflar
        <button class="btn-sm" id="expCls">Kaydet</button>
        <label class="btn-sm">Yükle <input id="impCls" type="file" accept="application/json" style="width:auto;display:none"></label>
      </span>
    </div>
    <table>
      <thead>
        <tr><th>Ad</th><th>Kontenjan</th><th>Düzey (5–8)</th><th>Gözetmen(ler)</th><th>Satır</th><th>Sütun</th><th></th></tr>
      </thead>
      <tbody id="classTbody"></tbody>
    </table>
    <div class="small" style="margin-top:6px">
      İpucu: <b>Satır</b> otomatik hesaplanır (⌈Kontenjan / Sütun⌉). Örn. 23 kişi ve 4 sütun ⇒ en az 6 satır.
    </div>
  </section>

  <!-- 3) TAKVİM -->
  <section id="takvim" class="card hidden">
    <h2>Deneme Takvimi</h2>
    <div class="grid cols-3">
      <div>
        <label>Deneme Tarihi</label>
        <input type="date" id="examDate" />
      </div>
      <div>
        <label>Düzey</label>
        <select id="examLevel">
          <option value="8">8. Sınıf</option>
          <option value="7">7. Sınıf</option>
          <option value="6">6. Sınıf</option>
          <option value="5">5. Sınıf</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnSaveExam" class="primary">Tarihi Kaydet</button>
      </div>
    </div>
    <div class="toolbar inline" style="flex-wrap:wrap">
      <span class="pill">Takvim
        <button class="btn-sm" id="expCal">Kaydet</button>
        <label class="btn-sm">Yükle <input id="impCal" type="file" accept="application/json" style="width:auto;display:none"></label>
      </span>
    </div>
    <div class="row">
      <div class="col">
        <h3>Kayıtlı Takvim</h3>
        <div id="calendarList" class="list"></div>
      </div>
    </div>
  </section>

  <!-- 4) ATAMA -->
  <section id="atama" class="card hidden">
    <h2>Atama & Sürükle-Bırak</h2>
    <div class="toolbar inline" style="flex-wrap:wrap">
      <div class="inline" style="gap:8px">
        <label class="inline">Düzey:
          <select id="filterLevel">
            <option value="8">8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option>
          </select>
        </label>
        <label class="inline">Sırala:
          <select id="sortBy">
            <option value="ad">Ada göre</option>
            <option value="no">Numaraya göre</option>
            <option value="soyad">Soyada göre</option>
            <option value="sinif">Sınıfa göre</option>
            <option value="rand">Rastgele</option>
          </select>
        </label>
        <button id="btnAutoAssign" class="primary">Otomatik Atama</button>
        <button id="btnClearAssign">Atamaları Temizle</button>
        <button id="btnShuffle" title="Tüm sınıflarda rastgele karıştır">Karıştır</button>
      </div>
      <div class="right">
        <span class="pill">Atamalar
          <button class="btn-sm" id="expAssign">Kaydet</button>
          <label class="btn-sm">Yükle <input id="impAssign" type="file" accept="application/json" style="width:auto;display:none"></label>
        </span>
      </div>
    </div>
    <div class="row" id="assignArea"></div>
  </section>

  <!-- 5) YAZDIR -->
  <section id="yazdir" class="card hidden">
    <h2>Yazdır</h2>
    <div class="grid cols-2 no-print">
      <div class="card">
        <h3>Liste Yazdır</h3>
        <button onclick="printLists()" class="primary">Öğrenci Listeleri Yazdır</button>
      </div>
      <div class="card">
        <h3>Oturma Planı Yazdır</h3>
        <button onclick="printSeating()" class="primary">Oturma Planı Yazdır</button>
      </div>
    </div>
    <div class="small no-print">Yazdırmadan önce atamaların yapıldığından emin olun.</div>
    <div id="printRoot" class="hidden"></div>
  </section>

</div>

<div id="modalRoot" class="hidden"></div>

<script>
/* ===================== DURUM ===================== */
const state = {
  cfg: {
    sheetId: "1OeDI5rQvWXP6s5OhgRFrh1dThnBMmA9mrCjgYuk1Qtw",
    tabStudents: "Deneme",
    tabTeachers: "Ogretmenler",
    theme: "dark",
  },
  students: [],
  teachers: [],
  classes: [],  // {id,name,cap,level,teacherIds,rows,cols,students,_lock}
  calendar: [],
};

/* ===================== ARAÇLAR ===================== */
async function fetchSheet(spreadsheetId, sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("E-Tablo okunamadı. Paylaşımı kontrol edin.");
  const txt = await res.text();
  const json = JSON.parse(txt.substring(txt.indexOf("(")+1, txt.lastIndexOf(")")));
  const cols = json.table.cols.map(c => (c.label ?? ""));
  const rows = json.table.rows.map(r => r.c?.map(c => (c? c.v : "")) || []);
  return {cols, rows};
}
function normalizeKey(s){
  return (s||"").toString().trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/ş/g,"s").replace(/ğ/g,"g").replace(/ı/g,"i").replace(/ç/g,"c").replace(/ö/g,"o").replace(/ü/g,"u")
    .replace(/\s|[^a-z0-9]/g,"");
}
function lastWord(s){ const p=(s||"").toString().trim().split(/\s+/); return p[p.length-1]||""; }
function gradeOf(sinif){ const m = (sinif||"").toString().trim().match(/^(\d)/); return m? m[1] : ""; }
function uid(){ return Math.random().toString(36).slice(2,9); }
function saveLocal(){ localStorage.setItem("deneme-app", JSON.stringify(state)); }
function loadLocal(){
  const s = localStorage.getItem("deneme-app"); if(!s) return false;
  try{ const obj = JSON.parse(s); Object.assign(state, obj); return true; }catch{ return false; }
}
function fmtDate(dstr){ if(!dstr) return "-"; const d=new Date(dstr+"T12:00:00"); return d.toLocaleDateString("tr-TR",{day:"numeric",month:"long",year:"numeric"}); }
function downloadJSON(name, data){
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
}
function pickAndRead(fileInput, cb){
  fileInput.onchange = (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ try{ cb(JSON.parse(r.result)); }catch{ alert("JSON okunamadı."); } fileInput.value=""; };
    r.readAsText(f);
  };
  fileInput.click();
}
function teacherNames(ids){
  if(!ids || !ids.length) return [];
  return ids.map(id => (state.teachers.find(t=>t.id===id)?.ad || id));
}

/* ====== Satır otomatik hesap ====== */
function recomputeRows(cls){
  const cols = Math.max(1, parseInt(cls.cols||1));
  const cap  = Math.max(0, parseInt(cls.cap||0));
  cls.rows = Math.max(1, Math.ceil(cap / cols)); /* Neden: sütun değişince satır güncellensin */
}
function normalizeClass(cls){
  if(typeof cls.cap!=="number") cls.cap = parseInt(cls.cap||0) || 0;
  if(typeof cls.cols!=="number") cls.cols = parseInt(cls.cols||1) || 1;
  recomputeRows(cls);
  if(!Array.isArray(cls.students)) cls.students=[];
  if(!Array.isArray(cls.teacherIds)) cls.teacherIds=[];
  if(typeof cls._lock!=="boolean") cls._lock=true;
  return cls;
}

/* ===================== NAV ===================== */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.dataset.tab;
    document.querySelectorAll("section.card").forEach(s=>s.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    if(id==="atama") renderAssignArea();
    if(id==="sinif") renderClassTable();
  });
});

/* ===================== VERİ ===================== */
async function loadData(){
  const sid = document.getElementById("sheetId").value.trim() || state.cfg.sheetId;
  const tabS = document.getElementById("sheetStudentTab").value.trim() || "Deneme";
  const tabT = document.getElementById("sheetTeacherTab").value.trim() || "Ogretmenler";
  state.cfg.sheetId=sid; state.cfg.tabStudents=tabS; state.cfg.tabTeachers=tabT;

  const s = await fetchSheet(sid, tabS);
  let labels = s.cols.map(c=>normalizeKey(c));
  let rows = s.rows.slice();
  const need = ["no","adsoyad","sinif"];
  let ok = need.every(k=>labels.includes(k));
  if(!ok && rows.length){
    const keys = rows[0].map(v=>normalizeKey(v));
    if(need.every(k=>keys.includes(k))){ labels=keys; rows=rows.slice(1); ok=true; }
  }
  let iNo = ok? labels.indexOf("no"):0,
      iAd = ok? labels.indexOf("adsoyad"):1,
      iSn = ok? labels.indexOf("sinif"):2;

  state.students = rows.map(r=>({
    no: (r[iNo]??"").toString().trim(),
    adsoyad: (r[iAd]??"").toString().trim(),
    sinif: (r[iSn]??"").toString().trim(),
  })).filter(x=>x.no && x.adsoyad);

  const t = await fetchSheet(sid, tabT);
  let tLabels = t.cols.map(c=>normalizeKey(c));
  let tRows = t.rows.slice();
  const tNeed=["id","ogretmenadi","brans"];
  let tOk = tNeed.every(k=>tLabels.includes(k));
  if(!tOk && tRows.length){
    const fk=tRows[0].map(v=>normalizeKey(v));
    if(tNeed.every(k=>fk.includes(k))){ tLabels=fk; tRows=tRows.slice(1); tOk=true; }
  }
  const iId = tOk? tLabels.indexOf("id"):0;
  const iNm = tOk? tLabels.indexOf("ogretmenadi"):1;
  const iBr = tOk? tLabels.indexOf("brans"):2;

  state.teachers = tRows.map(r=>({
    id:(r[iId]??"").toString().trim(),
    ad:(r[iNm]??"").toString().trim(),
    brans:(r[iBr]??"").toString().trim(),
  })).filter(x=>x.id && x.ad);

  document.getElementById("kpiStd").textContent = state.students.length;
  document.getElementById("kpiTch").textContent = state.teachers.length;
  document.getElementById("kpiLoad").textContent = new Date().toLocaleString();
  renderPeopleLists();
  saveLocal();
}
function renderPeopleLists(){
  const sampleStd = document.getElementById("sampleStd"); sampleStd.innerHTML = "";
  state.students.forEach(st=>{
    const el = document.createElement("div");
    el.className="student"; el.textContent = `${st.no} • ${st.adsoyad} • ${st.sinif}`;
    el.style.cursor="default";
    sampleStd.appendChild(el);
  });
  const sampleTch = document.getElementById("sampleTch"); sampleTch.innerHTML="";
  state.teachers.forEach(tc=>{
    const el=document.createElement("div");
    el.className="student"; el.textContent = `${tc.id} • ${tc.ad} • ${tc.brans}`;
    el.style.cursor="default";
    sampleTch.appendChild(el);
  });
}
document.getElementById("btnLoad").onclick=()=>wrap(loadData);
document.getElementById("btnSaveCfg").onclick=()=>{
  state.cfg.sheetId = document.getElementById("sheetId").value.trim() || state.cfg.sheetId;
  state.cfg.tabStudents = document.getElementById("sheetStudentTab").value.trim() || state.cfg.tabStudents;
  state.cfg.tabTeachers = document.getElementById("sheetTeacherTab").value.trim() || state.cfg.tabTeachers;
  saveLocal(); alert("Ayarlar kaydedildi.");
};
document.getElementById("btnLoadCfg").onclick=()=>{
  const ok = loadLocal();
  if(ok){
    document.getElementById("sheetId").value = state.cfg.sheetId;
    document.getElementById("sheetStudentTab").value = state.cfg.tabStudents;
    document.getElementById("sheetTeacherTab").value = state.cfg.tabTeachers;
    applyTheme();
    renderPeopleLists(); renderClassTable(); renderAssignArea(); renderCalendar();
    alert("Kayıtlı durum yüklendi.");
  }else alert("Kayıt bulunamadı.");
};
document.getElementById("sheetId").value = state.cfg.sheetId;

/* Bölüm bazlı JSON */
document.getElementById("expCfg").onclick=()=>downloadJSON("ayarlar.json", state.cfg);
document.getElementById("expStd").onclick=()=>downloadJSON("ogrenciler.json", state.students);
document.getElementById("expTch").onclick=()=>downloadJSON("ogretmenler.json", state.teachers);
document.getElementById("impCfg").addEventListener("click", e=>pickAndRead(e.target, data=>{
  if(!data || typeof data!=="object"){ alert("Geçersiz ayar dosyası."); return; }
  state.cfg = {...state.cfg, ...data};
  document.getElementById("sheetId").value=state.cfg.sheetId||"";
  document.getElementById("sheetStudentTab").value=state.cfg.tabStudents||"";
  document.getElementById("sheetTeacherTab").value=state.cfg.tabTeachers||"";
  applyTheme(); saveLocal(); alert("Ayarlar yüklendi.");
}));
document.getElementById("impStd").addEventListener("click", e=>pickAndRead(e.target, data=>{
  if(!Array.isArray(data)){ alert("Geçersiz öğrenci dosyası."); return; }
  state.students = data.filter(x=>x && x.no && x.adsoyad);
  document.getElementById("kpiStd").textContent = state.students.length;
  renderPeopleLists(); saveLocal(); alert("Öğrenciler yüklendi.");
}));
document.getElementById("impTch").addEventListener("click", e=>pickAndRead(e.target, data=>{
  if(!Array.isArray(data)){ alert("Geçersiz öğretmen dosyası."); return; }
  state.teachers = data.filter(x=>x && x.id && x.ad);
  document.getElementById("kpiTch").textContent = state.teachers.length;
  renderPeopleLists(); renderClassTable(); saveLocal(); alert("Öğretmenler yüklendi.");
}));

/* ===================== SINIF ===================== */
function renderClassTable(){
  const tb = document.getElementById("classTbody"); tb.innerHTML="";
  state.classes.forEach(cls=>{
    normalizeClass(cls);
    const tr=document.createElement("tr");
    const teacherOptions = state.teachers.map(t=>`<option value="${t.id}" ${cls.teacherIds?.includes(t.id)?"selected":""}>${t.id} • ${t.ad}</option>`).join("");
    tr.innerHTML=`
      <td><input value="${cls.name}" ${cls._lock? "disabled": ""}></td>
      <td><input type="number" min="0" value="${cls.cap}" ${cls._lock? "disabled": ""} title="Kontenjan"></td>
      <td><select ${cls._lock? "disabled": ""}>
        <option ${cls.level==8?"selected":""}>8</option>
        <option ${cls.level==7?"selected":""}>7</option>
        <option ${cls.level==6?"selected":""}>6</option>
        <option ${cls.level==5?"selected":""}>5</option>
      </select></td>
      <td><select multiple size="3" class="tchSel" ${cls._lock? "disabled": ""}>${teacherOptions}</select></td>
      <td><input type="number" min="1" value="${cls.rows}" disabled title="Satır otomatik hesaplanır"></td>
      <td><input type="number" min="1" value="${cls.cols}" ${cls._lock? "disabled": ""} title="Sütun"></td>
      <td>
        <div class="inline" style="gap:6px">
          <button data-edit="${cls.id}" class="btn-sm">${cls._lock? "Düzelt": "Kilitle"}</button>
          <button data-id="${cls.id}" class="danger btn-sm">Sil</button>
        </div>
      </td>
    `;

    const nameInput = tr.querySelector('input[title="Kontenjan"]')?.previousElementSibling || tr.querySelector('td:first-child input');
    const capInput  = tr.querySelector('input[title="Kontenjan"]');
    const levelSel  = tr.querySelectorAll("select")[0];
    const tchSel    = tr.querySelector(".tchSel");
    const rowsInput = tr.querySelector('input[title="Satır otomatik hesaplanır"]');
    const colsInput = tr.querySelector('input[title="Sütun"]');

    const nm = tr.querySelector('td:first-child input');

    (nm||nameInput).oninput=()=>{cls.name=(nm||nameInput).value; saveLocal();};

    capInput.oninput=()=>{
      const v = Math.max(0, parseInt(capInput.value||0));
      cls.cap = v;
      recomputeRows(cls); rowsInput.value = cls.rows;
      saveLocal(); syncCounts();
    };
    levelSel.onchange=()=>{cls.level=parseInt(levelSel.value); saveLocal();};
    tchSel.onchange=()=>{ cls.teacherIds = [...tchSel.selectedOptions].map(o=>o.value); saveLocal(); };

    colsInput.oninput=()=>{
      const v = Math.max(1, parseInt(colsInput.value||1));
      cls.cols = v;
      recomputeRows(cls); rowsInput.value = cls.rows;
      saveLocal();
    };

    tr.querySelector('button[data-id]').onclick=()=>{ if(confirm("Sınıf silinsin mi?")){ state.classes = state.classes.filter(x=>x.id!==cls.id); renderClassTable(); renderAssignArea(); saveLocal(); } };
    tr.querySelector('button[data-edit]').onclick=()=>{ cls._lock = !cls._lock; renderClassTable(); saveLocal(); };
    tb.appendChild(tr);
  });
}
document.getElementById("btnAddClass").onclick=()=>{
  const c = {id:uid(), name:`Sınıf ${state.classes.length+1}`, cap:20, level:8, teacherIds:[], rows:5, cols:4, students:[], _lock:true};
  recomputeRows(c);
  state.classes.push(c);
  renderClassTable(); renderAssignArea(); saveLocal();
};
document.getElementById("btnClearClass").onclick=()=>{
  if(confirm("Tüm sınıflar silinsin mi?")){ state.classes=[]; renderClassTable(); renderAssignArea(); saveLocal(); }
};
document.getElementById("expCls").onclick=()=>downloadJSON("siniflar.json", state.classes);
document.getElementById("impCls").addEventListener("click", e=>pickAndRead(e.target, data=>{
  if(!Array.isArray(data)){ alert("Geçersiz sınıf dosyası."); return; }
  state.classes = data.map(c=>normalizeClass({...c}));
  renderClassTable(); renderAssignArea(); saveLocal(); alert("Sınıflar yüklendi.");
}));

/* ===================== TAKVİM ===================== */
document.getElementById("btnSaveExam").onclick=()=>{
  const date = document.getElementById("examDate").value;
  const level = parseInt(document.getElementById("examLevel").value);
  if(!date) return alert("Tarih seçin.");
  const existingIdx = state.calendar.findIndex(c=>c.level===level);
  if(existingIdx>=0){ state.calendar[existingIdx].date = date; }
  else { state.calendar.push({level,date}); }
  renderCalendar(); saveLocal();
};
function renderCalendar(){
  const root = document.getElementById("calendarList"); root.innerHTML="";
  state.calendar.sort((a,b)=>a.level-b.level).forEach((c,idx)=>{
    const row = document.createElement("div"); row.className="gap-8";
    const text = document.createElement("div"); text.className="pill"; text.textContent = `${c.level}. Sınıf • ${fmtDate(c.date)}`;
    const editBtn = document.createElement("button"); editBtn.className="btn-sm"; editBtn.textContent="Düzelt";
    const delBtn  = document.createElement("button"); delBtn.className="btn-sm danger"; delBtn.textContent="Sil";
    delBtn.onclick=()=>{ if(confirm(`${c.level}. sınıf deneme tarihi silinsin mi?`)){ state.calendar.splice(idx,1); renderCalendar(); saveLocal(); } };
    editBtn.onclick=()=>startEditCalendar(idx);
    row.appendChild(text); row.appendChild(editBtn); row.appendChild(delBtn);
    root.appendChild(row);
  });
}
function startEditCalendar(idx){
  const root = document.getElementById("calendarList");
  const c = state.calendar[idx];
  const row = document.createElement("div"); row.className="gap-8";
  const editor = document.createElement("div"); editor.className="pill"; editor.style.display="flex"; editor.style.gap="8px"; editor.style.alignItems="center";
  const sel = document.createElement("select");
  [5,6,7,8].forEach(l=>{const op=document.createElement("option"); op.value=String(l); op.textContent=`${l}. Sınıf`; if(l===c.level) op.selected=true; sel.appendChild(op);});
  const dt = document.createElement("input"); dt.type="date"; dt.value=c.date || "";
  editor.appendChild(sel); editor.appendChild(dt);
  const save = document.createElement("button"); save.className="btn-sm"; save.textContent="Kaydet";
  const cancel = document.createElement("button"); cancel.className="btn-sm"; cancel.textContent="İptal";
  save.onclick=()=>{
    const newLevel = parseInt(sel.value), newDate = dt.value;
    if(!newDate) return alert("Tarih seçin.");
    const clash = state.calendar.findIndex((x,i)=>x.level===newLevel && i!==idx);
    if(clash>=0){ alert(`${newLevel}. sınıf için zaten bir tarih var.`); return; }
    state.calendar[idx] = {level:newLevel, date:newDate}; renderCalendar(); saveLocal();
  };
  cancel.onclick=()=>renderCalendar();
  const list = [...root.children]; root.replaceChild(row, list[idx]);
  row.appendChild(editor); row.appendChild(save); row.appendChild(cancel);
}
document.getElementById("expCal").onclick=()=>downloadJSON("takvim.json", state.calendar);
document.getElementById("impCal").addEventListener("click", e=>pickAndRead(e.target, data=>{
  if(!Array.isArray(data)){ alert("Geçersiz takvim dosyası."); return; }
  state.calendar = data.filter(x=>x && typeof x.level==="number" && x.date);
  renderCalendar(); saveLocal(); alert("Takvim yüklendi.");
}));

/* ===================== ATAMA ===================== */
document.getElementById("filterLevel").onchange=()=>renderAssignArea();
document.getElementById("sortBy").onchange=()=>renderAssignArea();

function getFilteredStudents(){
  const level = document.getElementById("filterLevel").value;
  const list = state.students.filter(s=>gradeOf(s.sinif)===level);
  const sort = document.getElementById("sortBy").value;
  if(sort==="ad") list.sort((a,b)=>a.adsoyad.localeCompare(b.adsoyad,"tr"));
  if(sort==="no") list.sort((a,b)=>parseInt(a.no)-parseInt(b.no));
  if(sort==="soyad") list.sort((a,b)=>lastWord(a.adsoyad).localeCompare(lastWord(b.adsoyad),"tr"));
  if(sort==="sinif") list.sort((a,b)=>a.sinif.localeCompare(b.sinif,"tr"));
  if(sort==="rand") shuffle(list);
  return list;
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

function findAssignment(no){
  for(const c of state.classes){
    const idx = (c.students||[]).indexOf(no);
    if(idx>=0) return {classId:c.id, index:idx};
  }
  return null;
}

function renderAssignArea(){
  const area = document.getElementById("assignArea"); area.innerHTML="";
  const levelSel = document.getElementById("filterLevel").value;
  const left = document.createElement("div"); left.className="col class-col";
  left.innerHTML = `<h3>${levelSel}. Sınıf Öğrenciler</h3><div id="pool" class="list drop"></div>`;
  area.appendChild(left);
  const pool = left.querySelector("#pool");

  const all = getFilteredStudents();
  const unassigned = [], assigned = [];
  all.forEach(st => (findAssignment(st.no) ? assigned : unassigned).push(st));

  unassigned.forEach(st=>pool.appendChild(renderStudentChip(st, "pool")));
  if(assigned.length){
    const sep=document.createElement("div"); sep.className="small"; sep.style.margin="6px 0"; sep.textContent="— Atanmışlar —";
    pool.appendChild(sep);
    assigned.forEach(st=>pool.appendChild(renderStudentChip(st, "pool-assigned")));
  }

  state.classes.filter(c=>String(c.level)===String(levelSel)).forEach(cls=>{
    normalizeClass(cls);
    const col = document.createElement("div"); col.className="col class-col";
    const tchNames = teacherNames(cls.teacherIds).join(", ") || "-";
    col.innerHTML = `
      <h3>${cls.name} <span class="small">(${(cls.students||[]).length}/${cls.cap})</span></h3>
      <div class="small">${cls.rows}×${cls.cols} oturma • Gözetmen: ${tchNames}</div>
      <div class="list drop" data-class="${cls.id}"></div>
    `;
    area.appendChild(col);
    const list = col.querySelector(".drop");
    (cls.students||[]).forEach(no=>{
      const st = state.students.find(s=>s.no===no);
      if(st) list.appendChild(renderStudentChip(st, "class", cls.id));
    });
  });

  enableDnD(); syncCounts();
}

function renderStudentChip(st, where="pool", classId=null){
  const el=document.createElement("div"); el.className="student"; el.dataset.no=st.no;
  el.draggable = (where==="pool");
  const meta = document.createElement("div"); meta.className="meta";
  meta.textContent = `${st.no} • ${st.adsoyad} • ${st.sinif}`;
  const act = document.createElement("div"); act.className="chip-actions";

  if(where==="pool"){
    const sel=document.createElement("select");
    const levelSel = document.getElementById("filterLevel").value;
    const targets = state.classes.filter(c=>String(c.level)===String(levelSel));
    const opt0=document.createElement("option"); opt0.value=""; opt0.textContent="Sınıf Seç";
    sel.appendChild(opt0);
    targets.forEach(c=>{
      const op=document.createElement("option"); op.value=c.id; op.textContent=`${c.name} (${(c.students||[]).length}/${c.cap})`;
      sel.appendChild(op);
    });
    const btn=document.createElement("button"); btn.className="btn-sm"; btn.textContent="Ata";
    btn.onclick=()=>{
      const cid = sel.value;
      if(!cid){ alert("Sınıf seçin."); return; }
      const cls = state.classes.find(c=>c.id===cid);
      if(!cls) return;
      if((cls.students||[]).includes(st.no)){ alert(`${st.adsoyad} zaten ${cls.name} sınıfında.`); return; }
      if((cls.students||[]).length >= cls.cap){ alert(`${cls.name} kapasitesi dolu.`); return; }
      moveStudent(st.no, cid);
      renderAssignArea(); saveLocal();
    };
    act.appendChild(sel); act.appendChild(btn);
  }

  if(where==="pool-assigned"){
    el.classList.add("assigned");
    el.draggable=false;
    const info = findAssignment(st.no);
    const clsName = state.classes.find(c=>c.id===info?.classId)?.name || "?";
    const badge=document.createElement("span"); badge.className="chip-badge"; badge.textContent=`${clsName}`;
    act.appendChild(badge);
  }

  if(where==="class"){
    const rm=document.createElement("button"); rm.className="btn-sm"; rm.textContent="Çıkar";
    rm.onclick=()=>{
      const cls = state.classes.find(c=>c.id===classId);
      if(!cls) return;
      cls.students = (cls.students||[]).filter(x=>x!==st.no);
      renderAssignArea(); saveLocal();
    };
    act.appendChild(rm);
  }

  el.appendChild(meta); el.appendChild(act);
  return el;
}

function enableDnD(){
  document.querySelectorAll(".drop").forEach(zone=>{
    zone.addEventListener("dragover",e=>{
      const fromNo = e.dataTransfer.getData("text/plain");
      if(!fromNo) return;
      e.preventDefault();
      zone.style.outline=`2px solid var(--accent)`;
    });
    zone.addEventListener("dragleave",()=>zone.style.outline="");
    zone.addEventListener("drop",e=>{
      e.preventDefault(); zone.style.outline="";
      const no = e.dataTransfer.getData("text/plain");
      if(!no) return;
      const targetClassId = zone.dataset.class || null;
      const src = findAssignment(no)?.classId || null;

      if(!targetClassId){
        if(!src) return;
        const cls = state.classes.find(c=>c.id===src);
        cls.students = (cls.students||[]).filter(x=>x!==no);
        renderAssignArea(); saveLocal();
        return;
      }

      const target = state.classes.find(c=>c.id===targetClassId);
      if((target.students||[]).includes(no)){
        target.students = target.students.filter(x=>x!==no);
        target.students.push(no);
        renderAssignArea(); saveLocal();
        return;
      }
      if((target.students||[]).length >= target.cap){
        alert(`${target.name} kapasitesi dolu.`);
        return;
      }
      moveStudent(no, targetClassId);
      renderAssignArea(); saveLocal();
    });
  });

  document.querySelectorAll(".student").forEach(chip=>{
    chip.addEventListener("dragstart",e=>{
      if(chip.classList.contains("assigned")){ e.preventDefault(); return; }
      e.dataTransfer.setData("text/plain", chip.dataset.no);
    });
    chip.addEventListener("dragover",e=>{
      const overNo = chip.dataset.no;
      const dragNo = e.dataTransfer.getData("text/plain");
      if(!dragNo || dragNo===overNo) return;
      e.preventDefault();
    });
    chip.addEventListener("drop",e=>{
      e.preventDefault();
      const dragNo = e.dataTransfer.getData("text/plain");
      const dropNo = chip.dataset.no;
      if(!dragNo || dragNo===dropNo) return;

      const a = findAssignment(dragNo);
      const b = findAssignment(dropNo);
      const aName = state.students.find(s=>s.no===dragNo)?.adsoyad || dragNo;
      const bName = state.students.find(s=>s.no===dropNo)?.adsoyad || dropNo;

      openSwapModal(aName, bName, ()=>{
        if(a && b){
          const clsA = state.classes.find(c=>c.id===a.classId);
          const clsB = state.classes.find(c=>c.id===b.classId);
          clsA.students[a.index] = dropNo;
          clsB.students[b.index] = dragNo;
        }else if(!a && b){
          const clsB = state.classes.find(c=>c.id===b.classId);
          clsB.students[b.index] = dragNo;
          state.classes.forEach(c=>{ c.students = (c.students||[]).filter(x=>x!==dragNo); });
        }else if(a && !b){
          moveStudent(dragNo, a.classId);
        }
        renderAssignArea(); saveLocal();
      });
    });
  });
}
function moveStudent(no, classId){
  const target = state.classes.find(c=>c.id===classId);
  if(!target) return;
  if((target.students||[]).includes(no)) return;
  state.classes.forEach(c=>{ c.students = (c.students||[]).filter(x=>x!==no); });
  if((target.students||[]).length >= target.cap){ alert(`${target.name} kapasitesi dolu.`); return; }
  target.students.push(no);
}
function syncCounts(){
  state.classes.forEach(c=>{
    const col = [...document.querySelectorAll(`[data-class="${c.id}"]`)].pop();
    if(!col) return;
    const count = (c.students||[]).length;
    col.parentElement.querySelector("h3").innerHTML = `${c.name} <span class="small">(${count}/${c.cap})</span>`;
    col.style.borderColor = count>c.cap ? "var(--danger)" : "var(--border)";
  });
}

document.getElementById("btnAutoAssign").onclick=()=>{
  const level = document.getElementById("filterLevel").value;
  const pool = getFilteredStudents().map(s=>s.no);
  state.classes.filter(c=>String(c.level)===String(level)).forEach(c=>c.students=[]);
  let idx=0;
  state.classes.filter(c=>String(c.level)===String(level)).forEach(c=>{
    c.students=[];
    for(let k=0;k<c.cap && idx<pool.length;k++,idx++){ c.students.push(pool[idx]); }
  });
  renderAssignArea(); saveLocal();
};
document.getElementById("btnClearAssign").onclick=()=>{
  const level = document.getElementById("filterLevel").value;
  state.classes.filter(c=>String(c.level)===String(level)).forEach(c=>c.students=[]);
  renderAssignArea(); saveLocal();
};
document.getElementById("btnShuffle").onclick=()=>{
  const level = document.getElementById("filterLevel").value;
  const all = state.classes.filter(c=>String(c.level)===String(level)).flatMap(c=>c.students);
  for(let i=all.length-1;i>0;i--){ const j=Math.random()* (i+1) | 0; [all[i],all[j]]=[all[j],all[i]]; }
  let p=0;
  state.classes.filter(c=>String(c.level)===String(level)).forEach(c=>{ c.students = all.slice(p, p+c.cap); p+=c.cap; });
  renderAssignArea(); saveLocal();
};
document.getElementById("expAssign").onclick=()=>{
  const payload = state.classes.map(c=>({id:c.id, name:c.name, level:c.level, students:c.students||[]}));
  downloadJSON("atamalar.json", payload);
};
document.getElementById("impAssign").addEventListener("click", e=>pickAndRead(e.target, data=>{
  if(!Array.isArray(data)){ alert("Geçersiz atama dosyası."); return; }
  data.forEach(item=>{
    const cls = state.classes.find(c=>c.id===item.id) || state.classes.find(c=>c.name===item.name && c.level===item.level);
    if(cls) cls.students = (item.students||[]).slice(0, cls.cap);
  });
  renderAssignArea(); saveLocal(); alert("Atamalar yüklendi.");
}));

/* ===================== YAZDIR ===================== */
function printLists(){
  const root = document.getElementById("printRoot"); root.innerHTML=""; root.classList.remove("hidden");
  state.classes.forEach(cls=>{
    const lvlCal = state.calendar.find(x=>x.level===cls.level);
    const page = document.createElement("div"); page.className="print-page print-list";
    const inv = teacherNames(cls.teacherIds).join(", ") || "-";

    const assignedCount = (cls.students||[]).length;
    const cap = Math.max(0, parseInt(cls.cap||0));
    const pct = cap>0 ? Math.round((assignedCount*100)/cap) : 0;

    page.innerHTML = `
      <div class="print-title">${cls.name} — ${cls.level}. Sınıf Deneme Listesi</div>
      <div class="print-sub">Sınav Tarihi: ${fmtDate(lvlCal?.date)} • Gözetmen: ${inv} • Kapasite: ${cap} • Doluluk: ${assignedCount}/${cap} (%${pct})</div>
      <table><thead><tr><th>#</th><th>NO</th><th>AD SOYAD</th><th>SINIF</th><th>İmza</th></tr></thead><tbody></tbody></table>
    `;
    const tbody = page.querySelector("tbody");
    (cls.students||[]).map(no=>state.students.find(s=>s.no===no)).forEach((st,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${st?.no||""}</td><td>${st?.adsoyad||""}</td><td>${st?.sinif||""}</td><td></td>`;
      tbody.appendChild(tr);
    });
    root.appendChild(page);
  });
  window.print();
  root.classList.add("hidden");
}

/* === Izgara (satır × sütun) oturma planı yazdır + Doluluk === */
function printSeating(){
  const root = document.getElementById("printRoot"); root.innerHTML=""; root.classList.remove("hidden");

  state.classes.forEach(cls=>{
    const page = document.createElement("div"); page.className="print-page";
    const lvlCal = state.calendar.find(x=>x.level===cls.level);
    const inv = teacherNames(cls.teacherIds).join(", ") || "-";

    const assigned = (cls.students||[]).map(no=>state.students.find(s=>s.no===no)?.adsoyad || "");
    const assignedCount = assigned.filter(Boolean).length;
    const cap = Math.max(0, parseInt(cls.cap||0));
    const pct = cap>0 ? Math.round((assignedCount*100)/cap) : 0;

    const totalSeats = Math.max(cls.cap, cls.rows * cls.cols);

    page.innerHTML = `
      <div class="print-title">${cls.name} — Oturma Planı (${cls.rows}×${cls.cols})</div>
      <div class="print-sub">Tarih: ${fmtDate(lvlCal?.date)} • Düzey: ${cls.level} • Gözetmen: ${inv} • Kapasite: ${cap} • Doluluk: ${assignedCount}/${cap} (%${pct})</div>
    `;

    const grid = document.createElement("div");
    grid.className = "seat-grid";
    grid.style.setProperty("--cols", String(Math.max(1, parseInt(cls.cols||1))));
    const rows = Math.max(1, parseInt(cls.rows||1));
    const cols = Math.max(1, parseInt(cls.cols||1));

    let idx=0;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        if(idx>=totalSeats) break;
        const name = assigned[idx] || "Boş";
        grid.appendChild(buildSeatCard(idx+1, name));
        idx++;
      }
    }

    page.appendChild(grid);
    root.appendChild(page);
  });

  window.print();
  root.classList.add("hidden");
}

/* Sıra (desk) ikonu + isim etiketi */
function buildSeatCard(idx, name){
  const el = document.createElement("div");
  el.className = "seat";
  el.innerHTML = `
    <div class="idx">${idx}</div>
    <svg viewBox="0 0 120 70" xmlns="http://www.w3.org/2000/svg" aria-label="Sıra">
      <rect x="10" y="20" rx="6" ry="6" width="100" height="28" fill="none" stroke="#000" stroke-width="2"/>
      <line x1="20" y1="48" x2="20" y2="64" stroke="#000" stroke-width="2"/>
      <line x1="100" y1="48" x2="100" y2="64" stroke="#000" stroke-width="2"/>
      <rect x="42" y="4" rx="4" ry="4" width="36" height="10" fill="none" stroke="#000" stroke-width="2"/>
      <line x1="48" y1="14" x2="48" y2="20" stroke="#000" stroke-width="2"/>
      <line x1="84" y1="14" x2="84" y2="20" stroke="#000" stroke-width="2"/>
    </svg>
    <div class="nm">${name}</div>
  `;
  return el;
}

/* ===================== MODAL ===================== */
function openSwapModal(nameA, nameB, onConfirm){
  const root = document.getElementById("modalRoot");
  root.classList.remove("hidden");
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal">
        <h3>Yer Değiştirme Onayı</h3>
        <div class="small">Aşağıdaki öğrencilerin yerleri değiştirilsin mi?</div>
        <div class="pill" style="margin-top:8px">${nameA}</div>
        <div style="text-align:center;margin:6px 0">↕</div>
        <div class="pill">${nameB}</div>
        <div class="btns">
          <button id="swapCancel" class="btn-sm">İptal</button>
          <button id="swapOk" class="btn-sm">Değiştir</button>
        </div>
      </div>
    </div>`;
  document.getElementById("swapCancel").onclick=()=>{ root.classList.add("hidden"); root.innerHTML=""; };
  document.getElementById("swapOk").onclick=()=>{
    try{ onConfirm && onConfirm(); } finally {
      root.classList.add("hidden"); root.innerHTML="";
    }
  };
}

/* ===================== TEMA ===================== */
const btnTheme = document.getElementById("btnTheme");
btnTheme.addEventListener("click", ()=>{
  state.cfg.theme = state.cfg.theme==="light" ? "dark" : "light";
  applyTheme(); saveLocal();
});
function applyTheme(){
  if(state.cfg.theme==="light"){
    document.body.classList.add("theme-light");
    btnTheme.textContent = "Tema: Koyu";
  }else{
    document.body.classList.remove("theme-light");
    btnTheme.textContent = "Tema: Açık";
  }
}

/* ===================== Bootstrap ===================== */
async function wrap(promise){
  try{ await promise(); }
  catch(err){ console.error(err); alert(err.message||String(err)); }
}
(function bootstrap(){
  state.classes = state.classes.map(c=>normalizeClass(c));
  applyTheme();
  /* İlk yüklemede sadece 'Ayarlar' açık kalsın */
  document.querySelectorAll("section.card").forEach(s=>s.classList.add("hidden"));
  document.getElementById("ayarl").classList.remove("hidden");

  renderPeopleLists(); renderClassTable(); renderAssignArea(); renderCalendar();
})();
</script>
</body>
</html>
