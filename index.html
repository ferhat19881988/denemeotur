<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>SÄ±nÄ±f Oturma PlanÄ± YÃ¶neticisi v2</title>
<style>
  /* ====== TEMEL DEÄžÄ°ÅžKENLER (MODERN PALET) ====== */
  :root {
    --bg-body: #f8fafc;
    --bg-card: #ffffff;
    --bg-sidebar: #1e293b;
    --text-main: #334155;
    --text-muted: #64748b;
    --text-light: #f1f5f9;
    
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --danger: #ef4444;
    --success: #10b981;
    --warning: #f59e0b;
    --border: #e2e8f0;
    
    --radius: 8px;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
  }

  /* Koyu Tema DesteÄŸi */
  .dark-mode {
    --bg-body: #0f172a;
    --bg-card: #1e293b;
    --bg-sidebar: #020617;
    --text-main: #e2e8f0;
    --text-muted: #94a3b8;
    --text-light: #f8fafc;
    --border: #334155;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    background-color: var(--bg-body);
    color: var(--text-main);
    font-family: var(--font-ui);
    height: 100vh;
    display: flex;
    overflow: hidden;
    transition: background-color 0.3s, color 0.3s;
  }

  /* ====== LAYOUT ====== */
  .app-container {
    display: flex;
    width: 100%;
    height: 100%;
  }

  /* Sidebar */
  .sidebar {
    width: 260px;
    background-color: var(--bg-sidebar);
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    padding: 1rem;
    flex-shrink: 0;
  }
  .brand {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #fff;
  }
  .nav-menu {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex: 1;
  }
  .nav-item {
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    cursor: pointer;
    color: #94a3b8;
    transition: all 0.2s;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .nav-item:hover { background-color: rgba(255,255,255,0.05); color: #fff; }
  .nav-item.active { background-color: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
  .nav-icon { width: 20px; height: 20px; fill: currentColor; }

  .sidebar-footer {
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 0.85rem;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* Main Content */
  .main-content {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    position: relative;
  }

  /* Section Styles */
  .section { display: none; animation: fadeIn 0.3s ease; }
  .section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  h1, h2, h3 { margin-top: 0; color: var(--text-main); }
  h2 { font-size: 1.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; }

  /* Cards */
  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    margin-bottom: 1.5rem;
  }

  /* Form Elements */
  .form-group { margin-bottom: 1rem; }
  label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.5rem; }
  input, select, textarea {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background-color: var(--bg-body);
    color: var(--text-main);
    font-family: inherit;
    transition: border-color 0.2s;
  }
  input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

  /* Buttons */
  .btn {
    display: inline-flex; align-items: center; gap: 8px; justify-content: center;
    padding: 0.6rem 1.2rem;
    border-radius: var(--radius);
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
  }
  .btn-primary { background-color: var(--primary); color: white; }
  .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
  .btn-danger { background-color: var(--danger); color: white; }
  .btn-danger:hover { background-color: #dc2626; }
  .btn-ghost { background-color: transparent; border: 1px solid var(--border); color: var(--text-main); }
  .btn-ghost:hover { background-color: var(--border); }
  .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
  .btn-icon { padding: 0.5rem; aspect-ratio: 1; border-radius: 50%; }

  /* Grid Layouts */
  .grid { display: grid; gap: 1.5rem; }
  .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
  .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
  
  /* Tables */
  .table-container { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; text-align: left; }
  th, td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); }
  th { background-color: var(--bg-body); font-weight: 600; color: var(--text-muted); white-space: nowrap; }
  tr:last-child td { border-bottom: none; }
  
  /* Drag & Drop Areas */
  .drag-container {
    display: flex; gap: 1.5rem; align-items: flex-start; height: calc(100vh - 140px); overflow: hidden;
  }
  .student-pool {
    width: 280px; flex-shrink: 0; display: flex; flex-direction: column;
    background: var(--bg-card); border-right: 1px solid var(--border);
    padding-right: 1rem; height: 100%;
  }
  .class-drop-zone {
    flex: 1; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 1rem; padding-bottom: 2rem;
  }
  
  /* Student Chips */
  .student-chip {
    padding: 0.6rem 0.8rem;
    margin-bottom: 0.5rem;
    background: var(--bg-body);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: grab;
    display: flex; align-items: center; justify-content: space-between;
    font-size: 0.85rem;
    user-select: none;
    transition: transform 0.1s, box-shadow 0.2s;
  }
  .student-chip:hover { border-color: var(--primary); }
  .student-chip:active { cursor: grabbing; transform: scale(0.98); }
  .student-chip.assigned { opacity: 0.5; background: #e2e8f0; text-decoration: line-through; pointer-events: none; }
  
  .class-box {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); width: 300px; display: flex; flex-direction: column;
    transition: border-color 0.2s;
  }
  .class-box.drag-over { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary); background-color: rgba(59, 130, 246, 0.05); }
  .class-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); }
  .class-body { padding: 0.5rem; min-height: 150px; max-height: 400px; overflow-y: auto; }
  
  /* Toast Notifications */
  .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
  .toast {
    background: var(--bg-sidebar); color: #fff; padding: 12px 20px; border-radius: var(--radius);
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    display: flex; align-items: center; gap: 10px;
    animation: slideIn 0.3s ease forwards;
    pointer-events: auto; min-width: 250px;
  }
  .toast.success { border-left: 4px solid var(--success); }
  .toast.error { border-left: 4px solid var(--danger); }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  
  /* Stats Badge */
  .badge { display: inline-block; padding: 0.25em 0.6em; font-size: 75%; font-weight: 700; border-radius: 999px; background: var(--primary); color: #fff; }

  /* Print Styles */
  @media print {
    .sidebar, .no-print, .toast-container { display: none !important; }
    .app-container { display: block; height: auto; }
    .main-content { padding: 0; overflow: visible; }
    .section { display: none; }
    #printRoot { display: block !important; }
    
    .print-page { page-break-after: always; padding: 20px; margin: 0; }
    .print-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
    .print-title { font-size: 24px; font-weight: bold; }
    .print-meta { font-size: 14px; margin-top: 5px; }
    
    table { font-size: 12px; width: 100%; border: 1px solid #000; }
    th, td { border: 1px solid #000; padding: 4px; }
    
    /* Seat Grid Print */
    .seat-grid {
      display: grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      gap: 15px;
    }
    .seat-card {
      border: 1px solid #000; border-radius: 8px; padding: 10px;
      display: flex; flex-direction: column; align-items: center; text-align: center;
      height: 80px; justify-content: center;
    }
    .seat-idx { font-size: 10px; font-weight: bold; margin-bottom: 4px; }
    .seat-name { font-size: 13px; font-weight: 600; line-height: 1.2; }
  }
</style>
</head>
<body>

<div class="app-container">
  
  <aside class="sidebar no-print">
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      Plan YÃ¶netici v2
    </div>
    
    <nav class="nav-menu">
      <div class="nav-item active" onclick="switchTab('ayarlar')">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" fill="currentColor"/><path d="M20 12a8 8 0 0 0-2-6l-.4-2.6A9 9 0 0 0 2.4 6l-.4 2.6a8 8 0 0 0 0 6.8l.4 2.6a9 9 0 0 0 15.2 2.6l.4-2.6c.6-2 .6-4.8 0-6.8Z" fill="currentColor"/></svg>
        Ayarlar & Veri
      </div>
      <div class="nav-item" onclick="switchTab('siniflar')">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 4h18v16H3V4zm2 2v12h14V6H5z" fill="currentColor"/></svg>
        SÄ±nÄ±f DÃ¼zeni
      </div>
      <div class="nav-item" onclick="switchTab('takvim')">
        <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" fill="currentColor"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Takvim
      </div>
      <div class="nav-item" onclick="switchTab('atama')">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
        Oturma PlanÄ±
      </div>
      <div class="nav-item" onclick="switchTab('yazdir')">
        <svg class="nav-icon" viewBox="0 0 24 24"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
        YazdÄ±r
      </div>
    </nav>

    <div class="sidebar-footer">
      <span id="themeToggle" style="cursor:pointer" title="TemayÄ± DeÄŸiÅŸtir">ðŸŒ™ Koyu Mod</span>
      <span id="version">v2.1</span>
    </div>
  </aside>

  <main class="main-content">
    
    <section id="ayarlar" class="section active">
      <h2>Veri KaynaÄŸÄ± & Ayarlar</h2>
      
      <div class="grid grid-2">
        <div class="card">
          <h3>Google E-Tablo BaÄŸlantÄ±sÄ±</h3>
          <div class="form-group">
            <label>Spreadsheet ID</label>
            <input id="sheetId" placeholder="Google Sheet ID yapÄ±ÅŸtÄ±rÄ±n..." />
          </div>
          <div class="grid grid-2" style="gap:10px">
             <div><label>Ã–ÄŸrenci SayfasÄ±</label><input id="tabStd" value="Deneme" /></div>
             <div><label>Ã–ÄŸretmen SayfasÄ±</label><input id="tabTch" value="Ogretmenler" /></div>
          </div>
          <div style="margin-top:1rem; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="app.loadData()">Verileri Ã‡ek</button>
            <button class="btn btn-ghost" onclick="app.loadDemoData()">Demo Veri YÃ¼kle</button>
          </div>
          <p style="font-size:0.8rem; color:var(--text-muted); margin-top:10px">Not: Tablo "BaÄŸlantÄ±ya sahip olan herkes gÃ¶rÃ¼ntÃ¼leyebilir" modunda olmalÄ±dÄ±r.</p>
        </div>

        <div class="card">
          <h3>Sistem Ä°statistikleri</h3>
          <div class="grid grid-2">
             <div style="text-align:center; padding:10px; background:var(--bg-body); border-radius:var(--radius);">
               <div style="font-size:2rem; font-weight:bold; color:var(--primary)" id="statStd">0</div>
               <div style="font-size:0.8rem">Ã–ÄŸrenci</div>
             </div>
             <div style="text-align:center; padding:10px; background:var(--bg-body); border-radius:var(--radius);">
               <div style="font-size:2rem; font-weight:bold; color:var(--warning)" id="statTch">0</div>
               <div style="font-size:0.8rem">Ã–ÄŸretmen</div>
             </div>
          </div>
          <div style="margin-top:1rem">
            <label>Yedekleme Ä°ÅŸlemleri</label>
            <div style="display:flex; gap:8px; margin-top:5px">
              <button class="btn btn-sm btn-ghost" onclick="app.exportData()">TÃ¼m Veriyi Ä°ndir (.json)</button>
              <button class="btn btn-sm btn-ghost" onclick="document.getElementById('fileImp').click()">Veri YÃ¼kle</button>
              <input type="file" id="fileImp" hidden accept=".json" onchange="app.importData(this)" />
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>YÃ¼klenen Ã–ÄŸrenci Ã–nizleme (Ä°lk 5)</h3>
        <div id="previewList" style="font-size:0.9rem; color:var(--text-muted)">HenÃ¼z veri yÃ¼klenmedi.</div>
      </div>
    </section>

    <section id="siniflar" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
        <h2>SÄ±nÄ±f KonfigÃ¼rasyonu</h2>
        <button class="btn btn-primary" onclick="app.addClass()">+ Yeni SÄ±nÄ±f Ekle</button>
      </div>

      <div class="table-container bg-card">
        <table id="tblClasses">
          <thead>
            <tr>
              <th>SÄ±nÄ±f AdÄ±</th>
              <th>Kapasite</th>
              <th>DÃ¼zen (SatÄ±r x SÃ¼tun)</th>
              <th>Seviye</th>
              <th>GÃ¶zetmen</th>
              <th style="text-align:right">Ä°ÅŸlemler</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="takvim" class="section">
      <h2>SÄ±nav Takvimi</h2>
      <div class="card grid grid-3" style="align-items:end">
        <div>
          <label>Seviye</label>
          <select id="calLevel"><option value="8">8. SÄ±nÄ±f</option><option value="7">7. SÄ±nÄ±f</option><option value="6">6. SÄ±nÄ±f</option><option value="5">5. SÄ±nÄ±f</option></select>
        </div>
        <div>
          <label>Tarih</label>
          <input type="date" id="calDate" />
        </div>
        <button class="btn btn-primary" onclick="app.saveCalendar()">Tarihi Ayarla</button>
      </div>
      <div class="grid grid-2" id="calendarDisplay"></div>
    </section>

    <section id="atama" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
         <div style="display:flex; gap:10px; align-items:center">
           <h2>Oturma PlanÄ±</h2>
           <select id="assignLevel" onchange="app.renderAssignment()" style="width:auto; padding:5px 10px; font-weight:bold">
             <option value="8">8. SÄ±nÄ±flar</option>
             <option value="7">7. SÄ±nÄ±flar</option>
             <option value="6">6. SÄ±nÄ±flar</option>
             <option value="5">5. SÄ±nÄ±flar</option>
           </select>
         </div>
         <div style="display:flex; gap:8px">
           <button class="btn btn-ghost" onclick="app.autoDistribute()">âš¡ Otomatik DaÄŸÄ±t</button>
           <button class="btn btn-ghost" onclick="app.clearAssignment()">Temizle</button>
         </div>
      </div>

      <div class="drag-container">
        <div class="student-pool">
          <div style="margin-bottom:10px">
             <input type="text" id="searchStd" placeholder="Ã–ÄŸrenci ara..." onkeyup="app.renderPool()" />
          </div>
          <div style="flex:1; overflow-y:auto" id="poolList"></div>
        </div>

        <div class="class-drop-zone" id="dropZone"></div>
      </div>
    </section>

    <section id="yazdir" class="section">
      <h2>YazdÄ±rma SeÃ§enekleri</h2>
      <div class="grid grid-2 no-print">
        <div class="card" onclick="printMode='list'; window.print()" style="cursor:pointer; transition:transform 0.2s">
          <h3 style="color:var(--primary)">ðŸ“„ Ä°mza Listesi YazdÄ±r</h3>
          <p style="color:var(--text-muted)">Klasik tablo gÃ¶rÃ¼nÃ¼mÃ¼nde yoklama/imza listesi.</p>
        </div>
        <div class="card" onclick="printMode='seat'; window.print()" style="cursor:pointer; transition:transform 0.2s">
          <h3 style="color:var(--success)">ðŸª‘ Oturma PlanÄ± YazdÄ±r</h3>
          <p style="color:var(--text-muted)">SÄ±ra kutucuklarÄ± ÅŸeklinde gÃ¶rsel plan.</p>
        </div>
      </div>
    </section>

  </main>
</div>

<div class="toast-container" id="toastArea"></div>

<div id="printRoot" style="display:none"></div>

<script>
/* ===================== UYGULAMA MANTIÄžI ===================== */
const app = {
  data: {
    cfg: { sheetId: "", tabStd: "Deneme", tabTch: "Ogretmenler", theme: "light" },
    students: [],
    teachers: [],
    classes: [],
    calendar: []
  },

  init() {
    this.loadLocal();
    this.applyTheme();
    // Tab url hash kontrolÃ¼ veya default
    this.updateStats();
  },

  // --- Veri YÃ¶netimi ---
  async loadData() {
    const sid = document.getElementById("sheetId").value.trim();
    const ts = document.getElementById("tabStd").value.trim();
    const tt = document.getElementById("tabTch").value.trim();
    
    if(!sid) return toast("Sheet ID gerekli!", "error");
    
    try {
      toast("Veriler Ã§ekiliyor...", "info");
      const sData = await this.fetchSheet(sid, ts);
      const tData = await this.fetchSheet(sid, tt);
      
      this.data.students = this.parseSheet(sData, ["no","adsoyad","sinif"]);
      this.data.teachers = this.parseSheet(tData, ["id","ogretmenadi"]); // Basit parse
      
      // Config gÃ¼ncelle
      this.data.cfg = { ...this.data.cfg, sheetId: sid, tabStd: ts, tabTch: tt };
      
      this.saveLocal();
      this.updateStats();
      toast(`BaÅŸarÄ±lÄ±: ${this.data.students.length} Ã¶ÄŸrenci yÃ¼klendi.`, "success");
    } catch(e) {
      console.error(e);
      toast("Veri Ã§ekilemedi. Ä°zinleri kontrol edin.", "error");
    }
  },

  loadDemoData() {
    this.data.students = Array.from({length: 50}, (_,i) => ({
      no: (100+i).toString(), 
      adsoyad: `Ã–ÄŸrenci AdÄ± ${i+1}`, 
      sinif: i<25 ? "8-A" : "8-B"
    }));
    this.data.teachers = [{id:"T1", ad:"Ahmet Hoca"}, {id:"T2", ad:"AyÅŸe Hoca"}];
    this.data.classes = [
      {id: "c1", name: "Salon A", cap: 20, level: 8, rows: 5, cols: 4, students: [], teacherIds: ["T1"]},
      {id: "c2", name: "Salon B", cap: 20, level: 8, rows: 5, cols: 4, students: [], teacherIds: ["T2"]}
    ];
    this.saveLocal();
    this.updateUI();
    toast("Demo veriler yÃ¼klendi.", "success");
  },

  async fetchSheet(id, sheetName) {
    const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url);
    const txt = await res.text();
    // JSONP temizliÄŸi
    return JSON.parse(txt.substring(txt.indexOf("(") + 1, txt.lastIndexOf(")")));
  },

  parseSheet(json, requiredKeys) {
    if(!json.table || !json.table.rows) return [];
    // BaÅŸlÄ±klarÄ± bul (normalize et)
    const headers = json.table.cols.map(c => this.normalize(c.label || ""));
    // Ä°ndeksleri bul
    const idxs = requiredKeys.map(k => headers.findIndex(h => h.includes(k)));
    
    // SatÄ±rlarÄ± dÃ¶n
    return json.table.rows.map(r => {
      if(!r.c) return null;
      const obj = {};
      requiredKeys.forEach((key, i) => {
        const val = r.c[idxs[i]] ? r.c[idxs[i]].v : "";
        obj[key === "ogretmenadi" ? "ad" : key] = String(val).trim(); // Mapping
      });
      return obj;
    }).filter(x => x && x[requiredKeys[0]]); // Ä°lk key boÅŸ deÄŸilse al
  },

  normalize(str) {
    return str.toLowerCase().replace(/ÄŸ/g,"g").replace(/Ã¼/g,"u").replace(/ÅŸ/g,"s").replace(/Ä±/g,"i").replace(/Ã¶/g,"o").replace(/Ã§/g,"c").replace(/\s/g,"");
  },

  updateStats() {
    document.getElementById("statStd").textContent = this.data.students.length;
    document.getElementById("statTch").textContent = this.data.teachers.length;
    
    const preview = this.data.students.slice(0,5).map(s => `<div>${s.no} - ${s.adsoyad} (${s.sinif})</div>`).join("");
    document.getElementById("previewList").innerHTML = preview || "Veri yok.";
    
    // InputlarÄ± doldur
    document.getElementById("sheetId").value = this.data.cfg.sheetId || "";
    
    this.renderClasses();
    this.renderCalendarDisplay();
  },

  // --- SÄ±nÄ±f YÃ¶netimi ---
  renderClasses() {
    const tbody = document.querySelector("#tblClasses tbody");
    tbody.innerHTML = "";
    
    this.data.classes.forEach(c => {
      const tr = document.createElement("tr");
      
      // Ã–ÄŸretmen SeÃ§imi
      const tchOpts = this.data.teachers.map(t => `<option value="${t.id}" ${c.teacherIds?.includes(t.id)?"selected":""}>${t.ad}</option>`).join("");
      
      tr.innerHTML = `
        <td><input value="${c.name}" onchange="app.updateClass('${c.id}', 'name', this.value)" /></td>
        <td><input type="number" style="width:70px" value="${c.cap}" onchange="app.updateClass('${c.id}', 'cap', this.value)" /></td>
        <td>
           <div style="display:flex; align-items:center; gap:5px">
             <input type="number" style="width:50px" placeholder="SatÄ±r" value="${c.rows||5}" disabled title="Oto HesaplanÄ±r">
             <span>x</span>
             <input type="number" style="width:50px" placeholder="SÃ¼tun" value="${c.cols||4}" onchange="app.updateClass('${c.id}', 'cols', this.value)">
           </div>
        </td>
        <td>
          <select onchange="app.updateClass('${c.id}', 'level', this.value)">
            <option value="8" ${c.level==8?"selected":""}>8</option>
            <option value="7" ${c.level==7?"selected":""}>7</option>
            <option value="6" ${c.level==6?"selected":""}>6</option>
            <option value="5" ${c.level==5?"selected":""}>5</option>
          </select>
        </td>
        <td>
          <select multiple style="height:40px" onchange="app.updateClassTch('${c.id}', this)">${tchOpts}</select>
        </td>
        <td style="text-align:right">
          <button class="btn btn-icon btn-danger" onclick="app.delClass('${c.id}')">ðŸ—‘</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  },

  addClass() {
    this.data.classes.push({
      id: "c" + Date.now(),
      name: `Yeni SÄ±nÄ±f ${this.data.classes.length+1}`,
      cap: 20, level: 8, rows: 5, cols: 4, students: [], teacherIds: []
    });
    this.saveLocal();
    this.renderClasses();
  },

  updateClass(id, field, val) {
    const c = this.data.classes.find(x => x.id === id);
    if(c) {
      if(field === "cap" || field === "cols") val = parseInt(val) || 1;
      if(field === "level") val = parseInt(val);
      c[field] = val;
      
      // SatÄ±r sayÄ±sÄ±nÄ± otomatik gÃ¼ncelle (Kapasite / SÃ¼tun)
      if(field === "cap" || field === "cols") {
        c.rows = Math.ceil(c.cap / c.cols);
      }
      this.saveLocal();
      this.renderClasses(); // Tabloyu yenile ki satÄ±r sayÄ±sÄ± gÃ¼ncellensin
    }
  },

  updateClassTch(id, selectEl) {
    const c = this.data.classes.find(x => x.id === id);
    if(c) {
      c.teacherIds = Array.from(selectEl.selectedOptions).map(o => o.value);
      this.saveLocal();
    }
  },

  delClass(id) {
    if(confirm("Bu sÄ±nÄ±fÄ± silmek istiyor musunuz?")) {
      this.data.classes = this.data.classes.filter(c => c.id !== id);
      this.saveLocal();
      this.renderClasses();
    }
  },

  // --- Takvim ---
  saveCalendar() {
    const lvl = parseInt(document.getElementById("calLevel").value);
    const date = document.getElementById("calDate").value;
    if(!date) return toast("Tarih seÃ§in", "error");
    
    const exist = this.data.calendar.find(x => x.level === lvl);
    if(exist) exist.date = date;
    else this.data.calendar.push({level: lvl, date});
    
    this.saveLocal();
    this.renderCalendarDisplay();
    toast(`${lvl}. sÄ±nÄ±flar iÃ§in tarih ayarlandÄ±.`, "success");
  },

  renderCalendarDisplay() {
    const div = document.getElementById("calendarDisplay");
    div.innerHTML = this.data.calendar.sort((a,b)=>a.level-b.level).map(c => `
      <div class="card" style="margin:0; padding:10px; border-left:4px solid var(--primary)">
        <strong>${c.level}. SÄ±nÄ±flar</strong>
        <div style="color:var(--text-muted)">${new Date(c.date).toLocaleDateString("tr-TR")}</div>
      </div>
    `).join("");
  },

  // --- Oturma PlanÄ± (Drag & Drop) ---
  renderAssignment() {
    const level = parseInt(document.getElementById("assignLevel").value);
    const dropZone = document.getElementById("dropZone");
    dropZone.innerHTML = "";

    // Ä°lgili sÄ±nÄ±flarÄ± getir
    const classes = this.data.classes.filter(c => c.level === level);
    
    if(classes.length === 0) {
      dropZone.innerHTML = `<div style="width:100%; text-align:center; color:var(--text-muted); padding:2rem">Bu seviyede sÄ±nÄ±f tanÄ±mlanmamÄ±ÅŸ. "SÄ±nÄ±f DÃ¼zeni" sekmesinden ekleyin.</div>`;
    }

    classes.forEach(c => {
      const box = document.createElement("div");
      box.className = "class-box";
      box.dataset.id = c.id;
      
      const filled = (c.students || []).length;
      const isFull = filled >= c.cap;
      
      box.innerHTML = `
        <div class="class-header">
          <span style="font-weight:600">${c.name}</span>
          <span class="badge" style="background:${isFull?'var(--danger)':'var(--success)'}">${filled}/${c.cap}</span>
        </div>
        <div class="class-body" ondragover="app.onDragOver(event)" ondragleave="app.onDragLeave(event)" ondrop="app.onDrop(event, '${c.id}')">
          ${(c.students||[]).map(no => this.createChipHTML(no, true)).join("")}
        </div>
      `;
      dropZone.appendChild(box);
    });

    this.renderPool();
  },

  renderPool() {
    const level = parseInt(document.getElementById("assignLevel").value);
    const search = document.getElementById("searchStd").value.toLowerCase();
    const list = document.getElementById("poolList");
    
    // Bu seviyedeki tÃ¼m Ã¶ÄŸrenciler
    let students = this.data.students.filter(s => {
      // SÄ±nÄ±f adÄ±ndan seviye bulma (Ã–rn: "8-A" -> 8)
      const grade = parseInt((s.sinif||"").match(/\d+/)?.[0] || 0);
      return grade === level;
    });

    // AramayÄ± uygula
    if(search) students = students.filter(s => s.adsoyad.toLowerCase().includes(search) || s.no.includes(search));

    // AtanmÄ±ÅŸlarÄ± bul
    const assignedNos = new Set();
    this.data.classes.forEach(c => {
       if(c.students) c.students.forEach(n => assignedNos.add(n));
    });

    list.innerHTML = students.map(s => {
      const isAssigned = assignedNos.has(s.no);
      if(isAssigned && !search) return ""; // AramÄ±yorsak atananlarÄ± havuzda gÃ¶sterme
      return `<div class="student-chip ${isAssigned?'assigned':''}" draggable="${!isAssigned}" ondragstart="app.onDragStart(event, '${s.no}')">
        <span><b>${s.no}</b> ${s.adsoyad}</span>
        <span style="font-size:0.75em; color:gray">${s.sinif}</span>
      </div>`;
    }).join("");
  },

  createChipHTML(no, removable=false) {
    const s = this.data.students.find(x => x.no === no);
    const name = s ? s.adsoyad : no;
    return `
    <div class="student-chip" style="cursor:default">
      <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:85%">${name}</span>
      ${removable ? `<span style="cursor:pointer; color:red; font-weight:bold" onclick="app.removeFromClass('${no}')">&times;</span>` : ''}
    </div>`;
  },

  // Drag Events
  onDragStart(e, no) {
    e.dataTransfer.setData("text/plain", no);
    e.dataTransfer.effectAllowed = "copy";
  },
  onDragOver(e) {
    e.preventDefault();
    e.currentTarget.parentElement.classList.add("drag-over");
  },
  onDragLeave(e) {
    e.currentTarget.parentElement.classList.remove("drag-over");
  },
  onDrop(e, classId) {
    e.preventDefault();
    document.querySelectorAll(".class-box").forEach(b => b.classList.remove("drag-over"));
    const no = e.dataTransfer.getData("text/plain");
    this.assignStudent(no, classId);
  },

  assignStudent(no, classId) {
    const cls = this.data.classes.find(c => c.id === classId);
    if(!cls) return;
    
    // Kapasite kontrolÃ¼
    if((cls.students||[]).length >= cls.cap) return toast("SÄ±nÄ±f kapasitesi dolu!", "error");
    
    // Zaten baÅŸka sÄ±nÄ±fta mÄ±? (AslÄ±nda UI'da engelledik ama Ã§ifte kontrol)
    let oldClass = null;
    this.data.classes.forEach(c => {
      if(c.students && c.students.includes(no)) oldClass = c;
    });
    
    if(oldClass) {
      oldClass.students = oldClass.students.filter(x => x !== no);
    }
    
    if(!cls.students) cls.students = [];
    cls.students.push(no);
    
    this.saveLocal();
    this.renderAssignment();
  },

  removeFromClass(no) {
    this.data.classes.forEach(c => {
      if(c.students) c.students = c.students.filter(x => x !== no);
    });
    this.saveLocal();
    this.renderAssignment();
  },

  autoDistribute() {
    if(!confirm("Mevcut atamalar temizlenip rastgele daÄŸÄ±tÄ±lacak. OnaylÄ±yor musunuz?")) return;
    
    const level = parseInt(document.getElementById("assignLevel").value);
    const targets = this.data.classes.filter(c => c.level === level);
    
    // Havuzu al
    let pool = this.data.students.filter(s => parseInt((s.sinif||"").match(/\d+/)?.[0]) === level);
    // KarÄ±ÅŸtÄ±r
    pool = pool.sort(() => Math.random() - 0.5);
    
    // Temizle
    targets.forEach(c => c.students = []);
    
    // DaÄŸÄ±t
    let sIdx = 0;
    targets.forEach(c => {
      for(let i=0; i<c.cap; i++) {
        if(sIdx < pool.length) {
          c.students.push(pool[sIdx].no);
          sIdx++;
        }
      }
    });
    
    this.saveLocal();
    this.renderAssignment();
    toast("Otomatik daÄŸÄ±tÄ±m tamamlandÄ±.", "success");
  },
  
  clearAssignment() {
    if(!confirm("TÃ¼m atamalar silinecek?")) return;
    const level = parseInt(document.getElementById("assignLevel").value);
    this.data.classes.filter(c => c.level === level).forEach(c => c.students = []);
    this.saveLocal();
    this.renderAssignment();
  },

  // --- YazdÄ±rma ---
  print(mode) {
    // Print logic global print listener'da handlediliyor, sadece DOM hazÄ±rlÄ±ÄŸÄ±
    const root = document.getElementById("printRoot");
    root.innerHTML = "";
    
    const relevantClasses = this.data.classes.filter(c => (c.students||[]).length > 0);
    
    relevantClasses.forEach(c => {
      const teacher = this.data.teachers.find(t => c.teacherIds?.[0] === t.id)?.ad || "-";
      const cal = this.data.calendar.find(cal => cal.level === c.level)?.date || "";
      const dateStr = cal ? new Date(cal).toLocaleDateString("tr-TR") : "-";

      const page = document.createElement("div");
      page.className = "print-page";
      
      let content = "";
      
      // Header
      const header = `
        <div class="print-header">
          <div class="print-title">${c.name} (${c.level}. SÄ±nÄ±f Deneme)</div>
          <div class="print-meta">
            Tarih: ${dateStr} | GÃ¶zetmen: ${teacher} | Doluluk: ${(c.students||[]).length}/${c.cap}
          </div>
        </div>
      `;

      if(printMode === 'list') {
        // Liste Modu
        const rows = (c.students||[]).map((no, i) => {
          const s = this.data.students.find(x => x.no === no) || {no, adsoyad:"?", sinif:"?"};
          return `<tr>
            <td style="width:30px">${i+1}</td>
            <td style="width:80px">${s.no}</td>
            <td>${s.adsoyad}</td>
            <td style="width:80px">${s.sinif}</td>
            <td style="width:100px"></td>
          </tr>`;
        }).join("");
        
        content = `
          <table>
            <thead><tr><th>#</th><th>No</th><th>Ad Soyad</th><th>SÄ±nÄ±f</th><th>Ä°mza</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      } else {
        // Oturma PlanÄ± Modu
        let seats = "";
        for(let i=0; i<c.cap; i++) {
           const no = c.students && c.students[i];
           const s = no ? (this.data.students.find(x => x.no === no) || {adsoyad:no}) : null;
           seats += `
             <div class="seat-card">
               <div class="seat-idx">${i+1}</div>
               <div class="seat-name">${s ? s.adsoyad : 'BOÅž'}</div>
             </div>
           `;
        }
        content = `<div class="seat-grid" style="--cols:${c.cols}">${seats}</div>`;
      }

      page.innerHTML = header + content;
      root.appendChild(page);
    });
  },

  // --- Genel YardÄ±mcÄ±lar ---
  saveLocal() {
    localStorage.setItem("planAppV2", JSON.stringify(this.data));
  },
  loadLocal() {
    const str = localStorage.getItem("planAppV2");
    if(str) {
      try {
         const json = JSON.parse(str);
         this.data = { ...this.data, ...json };
      } catch(e) { console.log("Veri okunamadÄ±"); }
    }
  },
  exportData() {
    const blob = new Blob([JSON.stringify(this.data)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "okul_plan_yedek.json";
    a.click();
  },
  importData(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (e) => {
      try {
        this.data = JSON.parse(e.target.result);
        this.saveLocal();
        location.reload();
      } catch(x){ toast("Dosya bozuk.", "error"); }
    };
    r.readAsText(f);
  },
  applyTheme() {
    if(this.data.cfg.theme === "dark") document.body.classList.add("dark-mode");
  },
  toggleTheme() {
    this.data.cfg.theme = this.data.cfg.theme === "light" ? "dark" : "light";
    document.body.classList.toggle("dark-mode");
    this.saveLocal();
  },
  updateUI() {
    // Sadece toplu UI refresh gereken yerler
    this.renderClasses();
    this.updateStats();
  }
};

/* ===================== GLOBAL HELPER ===================== */
let printMode = 'list';

window.addEventListener("beforeprint", () => {
  app.print(printMode);
});

function switchTab(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
  event.currentTarget.classList.add("active");
  
  if(id === "atama") app.renderAssignment();
  if(id === "siniflar") app.renderClasses();
}

function toast(msg, type="info") {
  const div = document.createElement("div");
  div.className = `toast ${type}`;
  div.textContent = msg;
  document.getElementById("toastArea").appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

document.getElementById("themeToggle").onclick = () => app.toggleTheme();

// BaÅŸlat
app.init();
</script>
</body>
</html>
